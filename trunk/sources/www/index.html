<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Yet Another DOMotic System">
    <meta name="author" content="yadoms team">
    <link rel="shortcut icon" href="assets/ico/favicon.png">

    <title>Yadoms</title>

    <!-- Bootstrap core CSS -->
    <link href="libs/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-non-responsive.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/yadoms.css" rel="stylesheet">
	<link href="libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/gridster.css" rel="stylesheet">

   <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=FontName">
   
    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../docs-assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

      <!-- Gridster includes -->
      <link href="libs/gridster/css/jquery.gridster.css" rel="stylesheet">
  </head>

  <body>

  <!-- Fixed navbar -->
  <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
          <div class="row" id="mainNavBar">
              <div class="col-md-12">
                  <div class="navbar-header">
                      <a class="navbar-brand" href="#">Yadoms</a>
                  </div>
                  <div class="navbar-collapse collapse">
                      <ul class="nav navbar-nav">
                          <li class="dropdown">
                              <a href="#" class="dropdown-toggle btn btn-inverse" data-toggle="dropdown"><i class="caret"></i></a>
                              <ul class="dropdown-menu">
                                  <li><a href="#">Configuration</a></li>
                                  <li><a href="#">Check For Update</a></li>
                                  <li><a href="#">...</a></li>
                                  <li class="divider"></li>
                                  <li class="dropdown-header">Shutdown/Restart</li>
                                  <li><a href="#">Shutdown</a></li>
                                  <li><a href="#">Restart</a></li>
                              </ul>
                          </li>
                      </ul>
                      <ul class="nav navbar-nav navbar-right">
                          <li><a href="#" class="btn btn-inverse" id="chartButton"><i class="fa fa-bar-chart-o"></i></a></li>
                          <li><a href="#" class="btn btn-inverse" id="customizeButton"><i class="fa fa-wrench"></i></a></li>
                      </ul>
                      </div>
                  </div>
              </div>
          <div class="row">
              <div class="col-md-12">
                  <div class="nav navbar-nav" id = "pageMenu">
                      <ul class="nav nav-pills nav-justified">
                          <!-- Nav pills of pages will be inserted here -->
                      </ul>
                  </div>
              </div>
          </div>
          </div><!--/.nav-collapse -->
      </div>
  </div>

  <div id="tabContainer">
      <div class="tab-content">
          <!-- Gridster tabs will be inserted here -->
      </div>

      <footer class="footer"><p>&copy; Yadoms 2014</p></footer>

  </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="libs/jquery/js/jquery-1.10.2.min.js"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js"></script>

    <!-- Gridster includes -->
    <!--TODO: reprendre la version min-->
    <script src="libs/gridster/js/jquery.gridster.min.js"></script>
    
	<script src="libs/transit/js/jquery.transit.min.js"></script>
	<script src="libs/knockout/js/knockout-3.0.0.js"></script>

    <div id="templates" class="hidden"></div>

	<script type="text/javascript">

    function Page() {
        this.pageData;
        this.gridster;
    }

    //var declaration
	var customization = false;
	var gridsterTab0;

    var pageArray = {};
    var widgetArray = {};
    var widgetViewModel;

	$( document ).ready(function() {

        var numberOfColumns = 9;
        var gridWidth = 100;
        var gridMargin = 5;

        $(".widgetPage .gridster").width(numberOfColumns * (gridWidth + gridMargin * 2));

        //we get pages
        $.getJSON( "/rest/page", function( data ) {
            //we parse the json answer
            $.each(data.page, function(index, value) {
                pageArray[value.id] = new Page();
                pageArray[value.id].pageData = value;
                var tabIdAsText = "tab" + value.id;

                $("#tabContainer .tab-content").append("<div class=\"widgetPage tab-pane active\" id=\"" + tabIdAsText + "\"><div class=\"gridster\"><ul></ul></div></div>")
                $("#pageMenu ul").append("<li><a href=\"#" + tabIdAsText + "\" data-toggle=\"tab\">" + value.name + "</a></li>");
                pageArray[value.id].gridster = $("#" + tabIdAsText + " ul").gridster({
                    widget_margins: [gridMargin, gridMargin],
                    widget_base_dimensions: [gridWidth, gridWidth],
                    min_cols: numberOfColumns,
                    max_cols: numberOfColumns,
                    resize: {
                        enabled: true,

                        resize: function(e, ui, $widget) {
                            str = $widget[0].id;
                            res = str.split("-");
                            id = res[1];
                            widgetArray[id].viewModel.resized($($("#widget" + id)[0]))
                        }
                    }
                }).data('gridster');
            });
            //we activate first page on the pills
            $("#pageMenu ul li").first().addClass("active");

            //we remove the active class of all hidden gridster
            $(".tab-content div").not($(".tab-content div").first()).removeClass("active");

            enableGridsterCustomization(false);
        });

        //we get widgets from REST

        $.getJSON( "/rest/widget", function( data ) {
            //we parse the json answer
            $.each(data.widget, function(index, value) {
                widgetArray[value.id] = value;
            });

            //we parse widgetArray
            $.each(widgetArray, function (index, value) {
                //for each widget we add viewModelData of the widget into the template section

                $.get( "widgets/" + value.name + "/view.html", function( data ) {
                    $("#templates").append(data);
                    //we get script to execute for this widget
                    $.getScript( "widgets/" + value.name + "/viewModel.js", function(data, textStatus, jqxhr) {
                        value.viewModel = widgetViewModel;
                        widgetViewModel = null;
                        pageArray[value.idPage].gridster.add_widget(
                                "<li class=\"widget\" id=\"liWidget-" + value.id +"\">" +
                                        "<div class=\"widgetCustomizationToolbar hidden\">" +
                                        "<div class=\"btn-group btn-group-sm\">" +
                                        "<button type=\"button\" class=\"btn btn-default\"><i class=\"fa fa-share\"></i></button>" +
                                        "<button type=\"button\" class=\"btn btn-default\"><i class=\"fa fa-cog\"></i></button>" +
                                        "<button type=\"button\" class=\"btn btn-default\"><i class=\"fa fa-times\"></i></button>" +
                                        "</div>" +
                                        "</div>" +
                                        "<div id=\"widget" + value.id + "\" data-bind=\"template: { name: '" + value.name + "-template', data: data }\"/>" +
                                        "</li>", value.sizeX, value.sizeY, value.positionX, value.positionY);
                        createdObject = $("#widget" + value.id);
                        ko.applyBindings(value.viewModel, createdObject[0]);
                        value.viewModel.resized(createdObject);
                    });
                });
            })
        });
	});

    function enableGridsterCustomization(enable) {
        $.each(pageArray, function (index, value) {
            if (enable)
            {
                value.gridster.enable();
                value.gridster.enable_resize();
            }
            else
            {
                value.gridster.disable();
                value.gridster.disable_resize();
            }
        });
    }

    function animateCustomizeButton() {
        $("#customizeButton i").transition({
          rotate: '+=30deg',
          duration: 500,
          easing: 'linear',
          complete: function() {
                if (customization)
                    animateCustomizeButton();
                else
                    $("#customizeButton i").transition({
                        rotate: '0deg',
                        duration: 100
                    });
            }
        });
    }
   
	$("#customizeButton").click(function() {
		customization = !customization;
		
		if (customization)
		{
			$("#customizeButton").removeClass('btn-inverse').addClass('btn-primary');
            enableGridsterCustomization(true);
            animateCustomizeButton();
            $(".widgetCustomizationToolbar").removeClass("hidden");
        }
		else
		{
			$("#customizeButton").removeClass('btn-primary').addClass('btn-inverse');
            enableGridsterCustomization(false);
            $(".widgetCustomizationToolbar").addClass("hidden");
		}
	});
	
	</script>
  </body>
</html>
