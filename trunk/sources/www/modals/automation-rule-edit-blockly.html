

<!--Edit automation Rule Modal -->
<div class="modal fade" id="edit-automation-rule-modal-blockly" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog edit-automation-rule-modal-blockly">
        <div class="modal-content">
           <form class="form-horizontal" novalidate >
              <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                   <h4 class="modal-title" data-i18n="modals.edit-automation-rule.title"></h4>
              </div>
                 <xml id="toolbox" style="display: none">
                    <block type="yadoms_keyword_value"></block>
                    <block type="yadoms_affect_keyword"></block>
                    <block type="yadoms_logic_compare_become"></block>
                    <block type="yadoms_logic_compare_is"></block>
                    <block type="logic_operation"></block>
                    <block type="logic_boolean"></block>
                    <block type="math_number"></block>
                    <block type="math_arithmetic"></block>
                    <block type="text"></block>
                 </xml>

              <div class="modal-body blockly-content"  >
              </div>


              <div class="modal-footer">
                 <div class="form-actions">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel"></button>
                    <button type="button" id="btn-confirm-configure-keyword" class="btn btn-primary" data-i18n="common.ok"></button>
                 </div>
              </div>
           </form>
        </div>
    </div>
</div>

<script>
   var currentAutomationRuleCondition;
   var activeAutomationRuleCondition;


   function showEditionAutomationRuleWithBlockly(rule, callback) {
      assert(!isNullOrUndefined(rule), "rule must be defined");
      assert($.isFunction(callback), "callback must be defined");

      var $modalContent = $("div#edit-automation-rule-modal-blockly .modal-content");

      //validation
      $("#btn-confirm-configure-keyword").bind("click", function (e) {

         Blockly.Validation.validateMainWorkspace(function(isValid, msg) {
            if(!isValid) {
               e.preventDefault();
               console.error("Fail to validate blockly : " + msg);
            } else {
               console.debug(msg);
               $('div#edit-automation-rule-modal-blockly').modal("hide");
               callback();
            }
         });


      });

      //when modal is shown; inject blockly
      $('div#edit-automation-rule-modal-blockly').on("shown.bs.modal", function () {
         //fix input field
         $(document).off('focusin.modal');

         //clear previously opened blockly
         $modalContent.find("div.blockly-content").empty();

         //inject blockly dom+js
         Blockly.inject($modalContent.find("div.blockly-content")[0], {toolbox: $modalContent.find('#toolbox')[0]});

         //create empty script (with fixed condition/action block)
         var xml = Blockly.Xml.textToDom("<xml xmlns=\"http://www.w3.org/1999/xhtml\"><block type=\"yadoms_controls_if\" id=\"10\" inline=\"false\" x=\"24\" y=\"39\" movable=\"false\" deletable=\"false\"></block></xml>");
         Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);

         //initialize validation
         Blockly.Validation.Init(1);

         //i18n
         $modalContent.i18n();
      });

      //we display the modal
      $('div#edit-automation-rule-modal-blockly').modal();
   }
</script>