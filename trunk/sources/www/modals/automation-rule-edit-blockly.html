<!--Edit automation Rule Modal -->
<div class="modal fade" id="edit-automation-rule-modal-blockly" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog edit-automation-rule-modal-blockly">
        <div class="modal-content">
           <form class="form-horizontal" novalidate >
              <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                   <h4 class="modal-title" data-i18n="modals.edit-automation-rule.title"></h4>
              </div>

              <div class="modal-body blockly-content"  >
              </div>


              <div class="modal-footer">
                 <div class="form-actions">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel"></button>
                    <button type="button" id="btn-confirm-configure-rule-blockly" class="btn btn-primary" data-i18n="common.ok"></button>
                 </div>
              </div>
           </form>
        </div>
    </div>
</div>

<script>
   var currentAutomationRuleCondition;
   var activeAutomationRuleCondition;


   function showEditionAutomationRuleWithBlockly(rule, callback) {
      assert(!isNullOrUndefined(rule), "rule must be defined");
      assert($.isFunction(callback), "callback must be defined");

      var $modalContent = $("div#edit-automation-rule-modal-blockly .modal-content");

      //validation
      $("#btn-confirm-configure-rule-blockly").bind("click", function (e) {

         Blockly.Validation.validateMainWorkspace(function(isValid, msg) {
            if(!isValid) {
               e.preventDefault();
               console.error("Fail to validate blockly : " + msg);
            } else {

               var xmlDomString = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
               var xmlString = Blockly.Xml.domToText(xmlDomString);
               var xmlStringForJson = encodeURIComponent(xmlString);


               rule.content = xmlStringForJson;

               $('div#edit-automation-rule-modal-blockly').modal("hide");
               callback(rule);
            }
         });


      });

      //when modal is shown; inject blockly
      $('div#edit-automation-rule-modal-blockly').on("shown.bs.modal", function () {
         //fix input field
         $(document).off('focusin.modal');

         //clear previously opened blockly
         $modalContent.find("div.blockly-content").empty();

         //load content
         var content = decodeURIComponent(rule.content);

         //load blockly
         Blockly.Yadoms.Initialize($modalContent.find("div.blockly-content")[0], content, 1);

         //i18n
         $modalContent.i18n();
      });

      //we display the modal
      $('div#edit-automation-rule-modal-blockly').modal();
   }
</script>