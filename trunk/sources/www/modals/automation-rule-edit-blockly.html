<!--Edit automation Rule Modal -->
<div class="modal fade" id="edit-automation-rule-modal-blockly" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog edit-automation-rule-modal-blockly">
        <div class="modal-content">
           <form class="form-horizontal" novalidate >
              <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                   <h4 class="modal-title" data-i18n="modals.edit-automation-rule.title"></h4>
              </div>
                 <xml id="toolbox" style="display: none">

                 <category name="Yadoms">
                    <block type="yadoms_keyword_value"></block>
                    <block type="yadoms_affect_keyword"></block>
                    <block type="yadoms_notification_simple"></block>
                    <block type="yadoms_notification_advanced"></block>
                    <block type="yadoms_enumeration"></block>
                 </category>


              <category name="Logic">
                 <block type="yadoms_logic_compare_become"></block>
                 <block type="yadoms_logic_compare_is"></block>
                 <block type="logic_compare"></block>
                 <block type="logic_operation"></block>
                 <block type="logic_negate"></block>
                 <block type="logic_boolean"></block>
                 <block type="logic_null"></block>
              </category>
              <category name="Loops">
                 <block type="controls_repeat_ext">
                    <value name="TIMES">
                       <block type="math_number">
                          <field name="NUM">10</field>
                       </block>
                    </value>
                 </block>
                 <block type="controls_whileUntil"></block>
                 <block type="controls_for">
                    <value name="FROM">
                       <block type="math_number">
                          <field name="NUM">1</field>
                       </block>
                    </value>
                    <value name="TO">
                       <block type="math_number">
                          <field name="NUM">10</field>
                       </block>
                    </value>
                    <value name="BY">
                       <block type="math_number">
                          <field name="NUM">1</field>
                       </block>
                    </value>
                 </block>
                 <block type="controls_forEach"></block>
                 <block type="controls_flow_statements"></block>
              </category>
              <category name="Math">
                 <block type="math_number"></block>
                 <block type="math_arithmetic"></block>
                 <block type="math_single"></block>
                 <block type="math_trig"></block>
                 <block type="math_constant"></block>
                 <block type="math_number_property"></block>
                 <block type="math_change">
                    <value name="DELTA">
                       <block type="math_number">
                          <field name="NUM">1</field>
                       </block>
                    </value>
                 </block>
                 <block type="math_round"></block>
                 <block type="math_on_list"></block>
                 <block type="math_modulo"></block>
                 <block type="math_constrain">
                    <value name="LOW">
                       <block type="math_number">
                          <field name="NUM">1</field>
                       </block>
                    </value>
                    <value name="HIGH">
                       <block type="math_number">
                          <field name="NUM">100</field>
                       </block>
                    </value>
                 </block>
                 <block type="math_random_int">
                    <value name="FROM">
                       <block type="math_number">
                          <field name="NUM">1</field>
                       </block>
                    </value>
                    <value name="TO">
                       <block type="math_number">
                          <field name="NUM">100</field>
                       </block>
                    </value>
                 </block>
                 <block type="math_random_float"></block>
              </category>
              <category name="Text">
                 <block type="text"></block>
                 <block type="text_join"></block>
                 <block type="text_append">
                    <value name="TEXT">
                       <block type="text"></block>
                    </value>
                 </block>
                 <block type="text_length"></block>
                 <block type="text_isEmpty"></block>
                 <block type="text_indexOf">
                    <value name="VALUE">
                       <block type="variables_get">
                          <field name="VAR">text</field>
                       </block>
                    </value>
                 </block>
                 <block type="text_charAt">
                    <value name="VALUE">
                       <block type="variables_get">
                          <field name="VAR">text</field>
                       </block>
                    </value>
                 </block>
                 <block type="text_getSubstring">
                    <value name="STRING">
                       <block type="variables_get">
                          <field name="VAR">text</field>
                       </block>
                    </value>
                 </block>
                 <block type="text_changeCase"></block>
                 <block type="text_trim"></block>
                 <!--
                 <block type="text_print"></block>
                 <block type="text_prompt_ext">
                    <value name="TEXT">
                       <block type="text"></block>
                    </value>
                 </block>
                 -->
              </category>
              <category name="Lists">
                 <block type="lists_create_empty"></block>
                 <block type="lists_create_with"></block>
                 <block type="lists_repeat">
                    <value name="NUM">
                       <block type="math_number">
                          <field name="NUM">5</field>
                       </block>
                    </value>
                 </block>
                 <block type="lists_length"></block>
                 <block type="lists_isEmpty"></block>
                 <block type="lists_indexOf">
                    <value name="VALUE">
                       <block type="variables_get">
                          <field name="VAR">list</field>
                       </block>
                    </value>
                 </block>
                 <block type="lists_getIndex">
                    <value name="VALUE">
                       <block type="variables_get">
                          <field name="VAR">list</field>
                       </block>
                    </value>
                 </block>
                 <block type="lists_setIndex">
                    <value name="LIST">
                       <block type="variables_get">
                          <field name="VAR">list</field>
                       </block>
                    </value>
                 </block>
                 <block type="lists_getSublist">
                    <value name="LIST">
                       <block type="variables_get">
                          <field name="VAR">list</field>
                       </block>
                    </value>
                 </block>
                 <block type="lists_split">
                    <value name="DELIM">
                       <block type="text">
                          <field name="TEXT">,</field>
                       </block>
                    </value>
                 </block>
              </category>
              <category name="Colour">
                 <block type="colour_picker"></block>
                 <block type="colour_random"></block>
                 <block type="colour_rgb">
                    <value name="RED">
                       <block type="math_number">
                          <field name="NUM">100</field>
                       </block>
                    </value>
                    <value name="GREEN">
                       <block type="math_number">
                          <field name="NUM">50</field>
                       </block>
                    </value>
                    <value name="BLUE">
                       <block type="math_number">
                          <field name="NUM">0</field>
                       </block>
                    </value>
                 </block>
                 <block type="colour_blend">
                    <value name="COLOUR1">
                       <block type="colour_picker">
                          <field name="COLOUR">#ff0000</field>
                       </block>
                    </value>
                    <value name="COLOUR2">
                       <block type="colour_picker">
                          <field name="COLOUR">#3333ff</field>
                       </block>
                    </value>
                    <value name="RATIO">
                       <block type="math_number">
                          <field name="NUM">0.5</field>
                       </block>
                    </value>
                 </block>
              </category>
              <sep></sep>
              </xml>

              <div class="modal-body blockly-content"  >
              </div>


              <div class="modal-footer">
                 <div class="form-actions">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel"></button>
                    <button type="button" id="btn-confirm-configure-rule-blockly" class="btn btn-primary" data-i18n="common.ok"></button>
                 </div>
              </div>
           </form>
        </div>
    </div>
</div>

<script>
   var currentAutomationRuleCondition;
   var activeAutomationRuleCondition;


   function showEditionAutomationRuleWithBlockly(rule, callback) {
      assert(!isNullOrUndefined(rule), "rule must be defined");
      assert($.isFunction(callback), "callback must be defined");

      var $modalContent = $("div#edit-automation-rule-modal-blockly .modal-content");

      //validation
      $("#btn-confirm-configure-rule-blockly").bind("click", function (e) {

         Blockly.Validation.validateMainWorkspace(function(isValid, msg) {
            if(!isValid) {
               e.preventDefault();
               console.error("Fail to validate blockly : " + msg);
            } else {
               console.debug(msg);

               var resultJson = Blockly.JSON.workspaceToObject(Blockly.mainWorkspace);

               var jsonString = JSON.stringify(resultJson);

               console.log(jsonString);

               $('div#edit-automation-rule-modal-blockly').modal("hide");
               callback();
            }
         });


      });

      //when modal is shown; inject blockly
      $('div#edit-automation-rule-modal-blockly').on("shown.bs.modal", function () {
         //fix input field
         $(document).off('focusin.modal');

         //clear previously opened blockly
         $modalContent.find("div.blockly-content").empty();

         Blockly.Yadoms.Initialize();

         //inject blockly dom+js
         Blockly.inject($modalContent.find("div.blockly-content")[0], {toolbox: $modalContent.find('#toolbox')[0]});

         //create empty script (with fixed condition/action block)
         var xml = Blockly.Xml.textToDom("<xml xmlns=\"http://www.w3.org/1999/xhtml\"><block type=\"yadoms_controls_if\" id=\"10\" inline=\"false\" x=\"24\" y=\"39\" editable=\"true\" movable=\"false\" deletable=\"false\"></block></xml>");
         Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);

         //initialize validation
         Blockly.Validation.Init(1);

         //i18n
         $modalContent.i18n();
      });

      //we display the modal
      $('div#edit-automation-rule-modal-blockly').modal();
   }
</script>