<div id="dashboard-recipients">
   <h1 class="page-header"><span class="fa fa-envelope"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.recipients.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.recipients.recipientsListDescription"></span><br>
   <button id="btn-add-new-recipient" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-rocket"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.recipients.new"></span></button>
   <table id="recipients-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.recipients.table.firstName"></td>
         <td data-i18n="modals.dashboard.sub-windows.recipients.table.lastName"></td>
         <td data-i18n="modals.dashboard.sub-windows.recipients.table.actions"></td>
      </tr>
      <!-- recipients list will be listed here-->
   </table>
</div>
<script>
   /**
    * Initialize the dashboard recipient page.
    * It loads data from server and show the recipient table
    */
   function initializeRecipientsDashboard() {
      //we remove all rows except header
      $("table#recipients-list").find("tr:gt(0)").remove();

      //bind the add recipient button click
      $("#btn-add-new-recipient").unbind("click").bind("click", addNewRecipient());

      //get all recipients from server and add them to dom
      RecipientManager.getAll(function(recipientList) {
         //foreach result we append a <tr>
         $.each(recipientList, function(index, value) {
            addRecipientToDom(value);
         });
      }, true);
   }

   /**
    * Get the dom row for a recipient
    * @param recipient   The recipient to get the dom row
    * @return The dom row
    */
   function getRecipientDomRow(recipient) {
      return $("table#recipients-list").find("tr[recipient-id='" + recipient.id + "']");
   }

   /**
    * Create a recipient row
    * @param recipient   The recipient attached to the new row
    */
   function createRecipientRow(recipient) {
      $("table#recipients-list").append("<tr recipient-id=\"" + recipient.id + "\" class=\"recipient\"><td class=\"recipient-firstName\"></td><td class=\"recipient-lastName\"></td><td class=\"recipient-actions\"></td></tr>");
   }

   /**
    * Update a recipient dom row with new data
    * @param recipient   The recipient which row is to update
    */
   function updateRecipientDom(recipient) {
      var actionsBtns = "<div class=\"btn-group\">\n" +
              "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.recipients.edit\"><span class=\"glyphicon glyphicon-pencil\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.recipients.delete\"><span class=\"glyphicon glyphicon-trash\"></span></button>\n" +
              "</div>";

      //retrieve the row
      var $recipientRow = getRecipientDomRow(recipient);

      var $firstName = "<span>" + recipient.firstName + "</span>";
      var $lastName = "<span>" + recipient.lastName + "</span>";

      //we fill the data
      $recipientRow.find("td.recipient-firstName").html($firstName);
      $recipientRow.find("td.recipient-lastName").html($lastName);

      //we add actions to the plugin
      $recipientRow.find("td.recipient-actions").empty().append(actionsBtns);

      //we bind event on the different actions
      $recipientRow.find("button.btn-delete").unbind('click').bind('click', deleteRecipient(recipient));
      $recipientRow.find("button.btn-configure").unbind('click').bind('click', configureRecipient(recipient));

      //apply i18n
      $recipientRow.i18n();
   }

   /**
    * Add a recipient to the table
    * @param recipient   The recipient to add
    */
   function addRecipientToDom(recipient) {
      //we add it to the DOM
      createRecipientRow(recipient);
      updateRecipientDom(recipient);
   }

   /**
    * Provide a function to delete a recipient (from server; and in DOM)
    * @param recipientToDelete The recipient to delete
    * @returns {Function} a function to call to delete a recipient
    */
   function deleteRecipient(recipientToDelete) {
      //recipientToDelete represent the recipient concerned
      return function(event) {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.recipients.confirmRecipientDeletion", {firstName:recipientToDelete.firstName, lastName:recipientToDelete.lastName}),
            function () {
               //deletion has been confirmed
               RecipientManager.deleteFromServer(recipientToDelete, function() {
                  //we remove recipientToDelete from dom
                  getRecipientDomRow(recipientToDelete).remove();
               });
            });
         });
      }
   }



   /**
    * Configure a recipient (show modal)
    * @param recipient The recipient to update
    * @param callback The callback used when operation is finished
    */
    function configureRecipientInternal(event, recipient, callback) {
      //recipient represent the recipient concerned
	      event.stopPropagation();
	      modals.recipientConfigure.load(function() {
		 showRecipientConfigurationModal(recipient, callback);
	      });
   }


   /**
    * Provide a function which display a modal form updating a recipient,
    * and after user validation, send data to server
    * @param recipientToConfigure The recipient to configure
    * @returns {Function} The configuration function to call to update a recipient
    */
   function configureRecipient(recipientToConfigure) {
      return function(event) {
         //show the recipient configuration modal
         configureRecipientInternal(event, recipientToConfigure, function (recipientConfigured) {
            //on validation success, update recipient to server
            RecipientManager.updateToServer(recipientConfigured, function(result, recipientUpdated){
               //on server operation success, update recipient table with updated data
               if(result)
                  updateRecipientDom(recipientUpdated);
            });
         });
      };
   }

   /**
    * Provide a function which create an empty recipient and ask user to fill it
    * @returns {Function} The function which create a recipient and show modal
    */
   function addNewRecipient() {
      return function(event) {
         //create an empty recipient
         var emptyRecipient = RecipientManager.createEmptyRecipient();
         //show the recipient configuration modal
         configureRecipientInternal(event, emptyRecipient, function (filledRecipient) {
            //on validation success, add the completed recipient to server
            RecipientManager.addToServer(filledRecipient, function(result, recipientAddedToServer){
               //on server operation success, add the recipient to the dashboard table
               if(result)
                  addRecipientToDom(recipientAddedToServer);
            });
         });
      };
   }


</script>
