<div id="dashboard-recipients">
   <h1 class="page-header"><span class="fa fa-envelope"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.recipients.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.recipients.recipientsListDescription"></span><br>
   <button id="btn-add-new-recipient" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-rocket"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.recipients.new"></span></button>
   <table id="recipients-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.recipients.table.firstName"></td>
         <td data-i18n="modals.dashboard.sub-windows.recipients.table.lastName"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.actions"></td>
      </tr>
      <!-- recipients list will be listed here-->
   </table>
</div>
<script>
   var recipientList = [];

   function initializeRecipientsDashboard() {
      //we remove all rows except header
      $("table#recipients-list").find("tr:gt(0)").remove();
      //we clear recipients list array
      recipientList = [];

       $("#btn-add-new-recipient").unbind("click").bind("click", addNewRecipient);

      RecipientManager.list(function(recipientList) {
         //foreach result we append a <tr>
         $.each(recipientList, function(index, value) {
            addRecipientToDom(value);
         });

      });
   }

   function getRecipientDomRow(recipient) {
      return $("table#recipients-list").find("tr[recipient-id='" + recipient.id + "']");
   }

   function getRecipientFieldsDomRow() {
      return $("table#recipients-list").find("tr.recipient-fields");
   }

   function getFieldDomRow(field) {
      return $("table#fields-list").find("tr[field-id='" + field.id + "']");
   }


   function addRecipientToDom(recip) {
      var actionsBtns = "<div class=\"btn-group\">\n" +
              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.recipients.delete\"><span class=\"glyphicon glyphicon-trash\"></span></button>\n" +
              "</div>";


      var $firstName = "<span>" + recip.firstName + "</span>";
      var $lastName = "<span>" + recip.lastName + "</span>";

      //we add it to the DOM
      var $recipientList = $("table#recipients-list");

      $recipientList.append("<tr recipient-id=\"" + recip.id + "\" class=\"recipient\"><td class=\"recipient-firstName\"></td><td class=\"recipient-lastName\"></td><td class=\"recipient-actions\"></td></tr>");

      var $recipientRow = getRecipientDomRow(recip);
      //we fill the data
      $recipientRow.find("td.recipient-firstName").html($firstName);
      $recipientRow.find("td.recipient-lastName").html($lastName);

      //we add actions to the plugin
      $recipientRow.find("td.recipient-actions").append(actionsBtns);

      //we bind event on the different actions
      $recipientRow.find("button.btn-delete").unbind('click').bind('click', deleteRecipient(recip));

      //we bind a click on row to show fields
      $recipientRow.unbind('click').bind('click', clickRecipient(recip));

      $recipientRow.i18n();
   }

   function deleteRecipient(recip) {
      //recip represent the recipient concerned
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.recipients.confirmRecipientDeletion", {firstName:recip.firstName, lastName:recip.lastName}),
            function () {
               //deletion has been confirmed
               RecipientManager.deleteFromServer(recip, function() {
                  //we remove recip from array
                  var i = recipientList.indexOf(recip);
                  if(i != -1) {
                     recipientList.splice(i, 1);
                  }
//
                  //we remove recip from dom
                  getRecipientDomRow(recip).remove();
               });
            });
         });
      }
   }


   function addNewRecipient() {
      /*
      modals.pluginAdd.load(function() {
         askPluginTypes(function(pluginType) {
            var pi = new PluginInstance(null, "", pluginType, "", 1, "user");
            //we get package.json
            PluginInstanceManager.downloadPackage(pi, function() {
               //we ask for configuration modal async
               modals.pluginConfigure.load(function() {
                  //we launch configureInstance GUI
                  configurePluginInstance(pi, function() {
                     //we ask for pluginInstance creation
                     PluginInstanceManager.createToServer(pi, function(result) {
                        //if it's okay
                        if (result) {
                           notifySuccess($.t("modals.configure-plugin.recipientsuccessfullyCreated"));
                           addPluginInstanceToDom(pi);
                           pluginInstanceList.push(pi);
                        }
                     });
                  });
               });
            });
         });
      });
      */
   }


   function clickRecipient(recip) {
      //recip represent the recipient concerned
      return function() {
            var $recipientRow = getRecipientDomRow(recip);

            var selectedClass = "info";

            //we remove the line that contains fields information
            var $details = getRecipientFieldsDomRow();
            if (!isNullOrUndefinedOrEmpty($details))
               $details.remove();

            //we look if this recipient is already selected
            if (!$recipientRow.hasClass(selectedClass)) {
               $recipientRow.siblings(".recipient").find("span.deploy").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
               //we select the line
               $recipientRow.find("span.deploy").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");
               $recipientRow.addClass(selectedClass).siblings(".recipient").removeClass(selectedClass);

               //we create recipient fields table
               $recipientRow.after("<tr recipient-id=\"" + recip.id + "\" class=\"recipient-fields " + selectedClass + "\"><td colspan=\"4\">" +
               "<div id=\"fields-list\" />"+
               "</td></tr>");

               $recipientFields = $("div#fields-list");


               $.each(recip.fields, function (index, field) {
                  $recipientFields.append("<tr field-id=\"" + field.id + "\"><td class=\"field-name vert-align\"></td><td class=\"field-value vert-align\"></td></tr>");
                  //var $fieldRow = getFieldDomRow(field);
                  ////we fill the data
                  //var name = "<span>" + decodeURIComponent(field.name) + "</span>";
                  //var value = "<span></span>";
//
                  //$fieldRow.find("td.field-name").html(name);
                  //$fieldRow.find("td.field-value").html(value);

                  //we append the text section

                  var valueParameter = new StringParameterHandler("common.recipientFields.", field.name, {required:"true", regex:field.verificationRegex}, field.value);

//                  $fieldRow.find("td.field-value").append(valueParameter.getDOMObject());
                  $recipientFields.append(valueParameter.getDOMObject());
                  //we finish friendlyNameParameter instantiation
                  if ($.isFunction(valueParameter.applyScript))
                     valueParameter.applyScript();





                  //we add actions to the keyword
                  //$fieldRow.find("td.keyword-actions").append(actionsBtns);

                  //we prevent from renaming keywords on system devices
                  //if ((!isNullOrUndefined(device.attachedPlugin)) && (device.attachedPlugin.category == PluginInstanceManager.systemCategory)) {
                  //   $fieldRow.find("button.btn-configure").addClass("disabled");
                  //}
                  //else {
                  //   //we bind event on the different actions
                  //   $fieldRow.find("button.btn-configure").unbind('click').bind('click', configureKeyword(keyword));
                  //}
               });

               $recipientFields.i18n();
            }
            else {
               $recipientRow.removeClass(selectedClass);
               $recipientRow.find("span.deploy").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
            }
      }
   }

</script>
