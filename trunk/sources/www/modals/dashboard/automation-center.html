<div id="dashboard-automation-center">
   <h1 class="page-header"><span class="fa fa-code-fork"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.automation-center.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.automation-center.description"></span><br>
   <button id="btn-add-new-automation-rule" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-code-fork"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.automation-center.new"></span></button>
   <button id="btn-add-new-automation-rule-blockly" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-code-fork"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.automation-center.blockly.new"></span></button>
   <table id="automation-rule-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.automation-center.table.enabled"></td>
         <td data-i18n="modals.dashboard.sub-windows.automation-center.table.name"></td>
         <td data-i18n="modals.dashboard.sub-windows.automation-center.table.description"></td>
         <td data-i18n="modals.dashboard.sub-windows.automation-center.table.triggers"></td>
         <td data-i18n="modals.dashboard.sub-windows.automation-center.table.trigerredActions"></td>
         <td data-i18n="modals.dashboard.sub-windows.automation-center.table.actions"></td>
      </tr>
      <!-- plugin instance will be listed here-->
   </table>
</div>
<script>
   var automationRuleInstanceList = [];

   function initializeAutomationCenterDashboard() {
      //we remove all rows except header
      $("table#automation-rule-list").find("tr:gt(0)").remove();
      //we clear automationRuleInstanceList array
      automationRuleInstanceList = [];

      $("#btn-add-new-automation-rule").unbind("click").bind("click", addNewAutomationRule);
      $("#btn-add-new-automation-rule-blockly").unbind("click").bind("click", addNewAutomationRuleWithBlockly);

      //we dynamically ask for automation-rule
      AutomationRuleManager.get(function (rules) {
         //foreach result we append a <tr>
         $.each(rules, function(index, value) {
            automationRuleInstanceList.push(value);
            //we don't show system plugins to user
            addRuleToDom(value);
         });

         //we use the periodic task of the dashboard
         clearInterval(periodicDashboardTask);
         periodicDashboardTask = setInterval(periodicDashboardAutomationCenterTask, 1000);
         periodicDashboardAutomationCenterTask();
      });
   }

   function getAutomationRuleDomRow(rule) {
      return $("table#automation-rule-list").find("tr[automation-rule-id='" + rule.id + "']");
   }

   function addAutomationRuleToDom(rule) {
      var actionsBtns = "<div class=\"btn-group\">\n" +
              "<button type=\"button\" class=\"btn btn-enableDisable\" data-i18n=\"[title]modals.dashboard.sub-windows.automation-center.enableDisable\"><span class=\"glyphicon glyphicon-off\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-primary btn-edit\" data-i18n=\"[title]modals.dashboard.sub-windows.automation-center.edit\"><span class=\"glyphicon glyphicon-cog\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.automation-center.delete\"><span class=\"glyphicon glyphicon-trash\"></span></button>\n" +
              "</div>";

      var enabledField = "<span class=\"label label-success label-status\"></span>\n";

      var name = "<span>" + rule.name + "</span>";
      var description = "<span>" + rule.description + "</span>";

      //we add it to the DOM
      var $ruleList = $("table#automation-rule-list");

      $ruleList.append("<tr automation-rule-id=\"" + rule.id + "\"><td class=\"automation-rule-enabled\"></td><td class=\"automation-rule-name\"></td><td class=\"automation-rule-description\"></td><td class=\"automation-rule-triggers\"></td><td class=\"automation-rule-triggeredActions\"></td><td class=\"automation-rule-actions\"></td></tr>");

      var $ruleRow = getAutomationRuleDomRow(rule);
      //we fill the data
      $ruleRow.find("td.automation-rule-name").html(name);
      $ruleRow.find("td.automation-rule-description").html(description);
      $ruleRow.find("td.automation-rule-enabled").html(enabledField);

      //we add actions to the plugin
      $ruleRow.find("td.automation-rule-actions").append(actionsBtns);

      //we bind event on the different actions
      $ruleRow.find("button.btn-enableDisable").unbind('click').bind('click', enableDisableAutomationRule(rule));
      $ruleRow.find("button.btn-edit").unbind('click').bind('click', editAutomationRule(rule));
      $ruleRow.find("button.btn-delete").unbind('click').bind('click', deleteAutomationRule(rule));

      $ruleRow.i18n();
   }

   function enableDisableAutomationRule(rule) {
      //rule represent the automation rule concerned
      return function() {
         //we deactivate the button until next status will be acquired to prevent flooding
         getAutomationRuleDomRow(rule).find("button.btn-enableDisable").prop('disabled', true);
         if (rule.enabled) {
            //we ask for disable
            AutomationRuleManager.disable(rule, function() { getAutomationRuleDomRow(rule).find("button.btn-enableDisable").prop('disabled', false);});
         }
         else
         {
            //we ask for enable
            AutomationRuleManager.enable(rule, function() { getAutomationRuleDomRow(rule).find("button.btn-enableDisable").prop('disabled', false);});
         }
      }
   }

   function editAutomationRule(rule) {
      //rule represent the automation rule concerned
      return function() {
         //we ask for configuration modal async
         modals.automationRuleEdit.load(function() {
            showEditionAutomationRule(rule, function() {
               AutomationRuleManager.updateToServer(rule, function(result) {
                  //We update the information that can have changed after the configuration
                  var $row = getAutomationRuleDomRow(rule);
                  $row.find("td.automation-rule-name").html(rule.name);
                  //TODO : add other information that may have changed
               });
            });
         });
      }
   }

   function deleteAutomationRule(rule) {
      //rule represent the automation rule concerned
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.automation-center.confirmDeletion", {name:rule.name}),
            function () {
               //deletion has been confirmed
               AutomationRuleManager.deleteFromServer(rule, function() {
                  //we remove rule from array
                  var i = automationRuleInstanceList.indexOf(rule);
                  if(i != -1) {
                     automationRuleInstanceList.splice(i, 1);
                  }

                  //we remove rule from dom
                  getAutomationRuleDomRow(rule).remove();
               });
            });
         });
      }
   }

   function periodicDashboardAutomationCenterTask() {
      //periodically we check the enable of each rule
      if (serverIsOnline) {
         $.each(automationRuleInstanceList, function(index, value) {
            //we ask async for the enable
            AutomationRuleManager.getOne(value.id, function (updatedRule) {
               var $row = getAutomationRuleDomRow(value);
               if (updatedRule.enabled != value.enabled) {
                  var textStatus = "";
                  var btn;
                  var label;

                  //TODO : find the right way to show the enable / disable
                  if(status) {
                     $row.find("span.label-status").addClass("label-success").removeClass("label-danger").text($.t("modals.dashboard.sub-windows.plugins.running"));
                     $row.find("button.btn-startStop").addClass("btn-warning").removeClass("btn-success");
                  }
                  else {
                     $row.find("span.label-status").addClass("label-danger").removeClass("label-success").text($.t("modals.dashboard.sub-windows.plugins.stopped"));
                     $row.find("button.btn-startStop").addClass("btn-success").removeClass("btn-warning");
                  }
               }
            });
         });
      }
   }

   function addNewAutomationRule() {
      modals.automationRuleEdit.load(function() {
         var rule = new AutomationRule(null, "", "", "", "", true);
         //we launch rule edition GUI
         showEditionAutomationRule(rule, function() {
            //we ask for automation rule creation
            AutomationRuleManager.createToServer(rule, function(result) {
               //if it's okay
               if (result) {
                  notifySuccess($.t("modals.dashboard.sub-windows.automation-center.ruleSuccessfullyCreated"));
                  addAutomationRuleToDom(rule);
                  automationRuleInstanceList.push(rule);
               }
            });
         });
      });
   }


   function addNewAutomationRuleWithBlockly() {
      modals.automationRuleEditBlockly.load(function() {
         var rule = new AutomationRule(null, "", "", "", "", true);
         //we launch rule edition GUI
         showEditionAutomationRuleWithBlockly(rule, function() {
            //we ask for automation rule creation
            AutomationRuleManager.createToServer(rule, function(result) {
               //if it's okay
               if (result) {
                  notifySuccess($.t("modals.dashboard.sub-windows.automation-center.ruleSuccessfullyCreated"));
                  addAutomationRuleToDom(rule);
                  automationRuleInstanceList.push(rule);
               }
            });
         });
      });
   }

</script>
