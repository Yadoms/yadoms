<div id="dashboard-system-configuration">
   <h1 class="page-header"><span class="fa fa-cogs"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.system-configuration.title"></span></h1>
   <form>
      <div class="form-group">
         <!--configuration will be inserted here-->
      </div>
      <div class="modal-footer">
         <div class="form-actions">
            <button id="resetSystemConfiguration" type="button" class="btn btn-default" data-i18n="common.resetToDefault"></button>
            <button type="submit" id="btn-confirm-configure-device" class="btn btn-primary" data-i18n="common.apply"></button>
         </div>
      </div>
   </form>
</div>

<script>
   var fakePassword = createUUID();

   function initializeSystemConfigurationDashboard() {
      var $modalBody = $("div#dashboard-system-configuration .form-group");
      $modalBody.empty();

      //get current system configuration
      ConfigurationManager.getSection(ConfigurationManager.items.systemSection, function(configuration) {
         if (!isNullOrUndefined(configuration)) {

            //we update system configuration to be sure to modify the latest version of the configuration
            systemConfiguration = configuration;
            var i18nContext = "modals.dashboard.sub-windows.system-configuration.configuration-items.";

            //*************
            //language
            var languageParameter = new EnumParameterHandler(i18nContext, ConfigurationManager.items.system.language, {"values" : isoLanguageCodes, "defaultValue" : systemConfiguration[ConfigurationManager.items.system.language].defaultValue}, systemConfiguration[ConfigurationManager.items.system.language].value);

            //*************
            //timezone
            //we create timezone selection list
            var timezones = {};
            $.each(moment.tz.zones(), function (index, value) {
               timezones[value.displayName] = value.displayName;
            });

            var timezoneParameter = new EnumParameterHandler(i18nContext, ConfigurationManager.items.system.timezone, {"values" : timezones, "defaultValue" : systemConfiguration[ConfigurationManager.items.system.timezone].defaultValue}, systemConfiguration[ConfigurationManager.items.system.timezone].value);

            //*************
            //Basic Authentication parameters
            var basicAuth = systemConfiguration[ConfigurationManager.items.system.basicAuthentication].value;

            //we affect a fake password if there is already one to help password modification detection
            var passwordToDisplay = "";
            if (basicAuth.password != "") {
               passwordToDisplay = fakePassword;
            }

            var basicAuthDefaultValue = systemConfiguration[ConfigurationManager.items.system.basicAuthentication].defaultValue;

            var value = {};
            value.checkbox = basicAuth.active;
            var basicAuthenticationSectionParameters = new SectionParameterHandler(i18nContext,
                                                  ConfigurationManager.items.system.basicAuthentication,
                                                  {
                                                     "enableWithCheckBox" : true,
                                                     "enableWithCheckBoxDefaultValue" : basicAuthDefaultValue.active
                                                  },
                                                  value);

            //*************
            //user authentication
            var userAuthenticationParameter = new StringParameterHandler(i18nContext,
                                                   ConfigurationManager.items.system.basicAuthenticationUser,
                                                   {
                                                      "defaultValue": basicAuthDefaultValue.user,
                                                      "required" : "true"
                                                   },
                                                   basicAuth.user);

            //*************
            //user authentication
            var passwordAuthenticationParameter = new StringParameterHandler(i18nContext,
                                                  ConfigurationManager.items.system.basicAuthenticationPassword,
                                                  {
                                                     "defaultValue": basicAuthDefaultValue.password,
                                                     "required" : "true",
                                                     "encrypted" : "true",
                                                     "decryptable" : "false"
                                                  },
                                                   passwordToDisplay);

            //*************
            //user authentication
            var password2AuthenticationParameter = new StringParameterHandler(i18nContext,
                                                  ConfigurationManager.items.system.basicAuthenticationPassword2,
                                                  {
                                                     "defaultValue": basicAuthDefaultValue.password,
                                                     "required" : "true",
                                                     "encrypted" : "true",
                                                     "decryptable" : "false",
                                                     "mustMatchTo" : passwordAuthenticationParameter.uuid
                                                  },
                                                   passwordToDisplay);

            basicAuthenticationSectionParameters.configurationHandlers.push(userAuthenticationParameter);
            basicAuthenticationSectionParameters.configurationHandlers.push(passwordAuthenticationParameter);
            basicAuthenticationSectionParameters.configurationHandlers.push(password2AuthenticationParameter);

            //*************
            //advanced parameters
            value = {};
            value.checkbox = systemConfiguration[ConfigurationManager.items.system.advancedParameters].value;
            var advancedSectionParameters = new SectionParameterHandler(i18nContext,
                                                   ConfigurationManager.items.system.advancedParameters,
                                                   {
                                                      "enableWithCheckBox" : true,
                                                      "enableWithCheckBoxDefaultValue" : systemConfiguration[ConfigurationManager.items.system.advancedParameters].defaultValue
                                                   },
                                                   value);

            //*************
            //developerMode
            var developerModeParameter = new BoolParameterHandler(i18nContext, ConfigurationManager.items.system.developerMode, {defaultValue: systemConfiguration[ConfigurationManager.items.system.developerMode].defaultValue}, systemConfiguration[ConfigurationManager.items.system.developerMode].value);
            advancedSectionParameters.configurationHandlers.push(developerModeParameter);

            //*************
            //dateFormatString
            var dateFormatStringParameter = new StringParameterHandler(i18nContext, ConfigurationManager.items.system.dateFormatString, {defaultValue: systemConfiguration[ConfigurationManager.items.system.dateFormatString].defaultValue, "required" : "true"}, systemConfiguration[ConfigurationManager.items.system.dateFormatString].value);
            advancedSectionParameters.configurationHandlers.push(dateFormatStringParameter);


            //and add it to the gui
            $modalBody.append(languageParameter.getDOMObject());
            $modalBody.append(timezoneParameter.getDOMObject());
            $modalBody.append(basicAuthenticationSectionParameters.getDOMObject());
            $modalBody.append(advancedSectionParameters.getDOMObject());

            //we finish controls instantiation
            if ($.isFunction(languageParameter.applyScript))
               languageParameter.applyScript();
            if ($.isFunction(timezoneParameter.applyScript))
               timezoneParameter.applyScript();
            if ($.isFunction(basicAuthenticationSectionParameters.applyScript))
               basicAuthenticationSectionParameters.applyScript();
            if ($.isFunction(advancedSectionParameters.applyScript))
               advancedSectionParameters.applyScript();

            //we i18n the form
            $modalBody.i18n();

            //validation form
            //erase previous jqBootstrapValidation
            $modalBody.find("input,select,textarea").jqBootstrapValidation("destroy").jqBootstrapValidation({
               preventSubmit: true,
               submitError: function($form, event, errors) {
                  console.warn("Unable to validate form: " + errors);
               },
               submitSuccess: function($form, event) {
                  event.preventDefault();
                  console.debug("End of system Configuration");

                  var errorOccurred = false;
                  var pageHasToBeReloaded = false;

                  //we save current configuration
                  //*************
                  //language
                  systemConfiguration[ConfigurationManager.items.system.language].value = languageParameter.getCurrentConfiguration();

                  if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.language])) {
                     errorOccurred = true;
                  }
                  else {
                     //we change language of i18n
                     i18n.setLng(systemConfiguration[ConfigurationManager.items.system.language].value, function() {
                        $("html").i18n();
                        moment.lang(systemConfiguration[ConfigurationManager.items.system.language].value);
                     });
                  }

                  //*************
                  //timezone
                  systemConfiguration[ConfigurationManager.items.system.timezone].value = timezoneParameter.getCurrentConfiguration();

                  if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.timezone])) {
                     errorOccurred = true;
                  }

                  //*************
                  //basic authentication
                  var value = {};

                  value.active = basicAuthenticationSectionParameters.getCurrentConfiguration().checkbox;

                  //if we activate / deactivate the authentication we must reload the page
                  if (value.active != basicAuth.active)
                     pageHasToBeReloaded = true;

                  if (value.active) {
                     //the authentication method is active
                     value.user = userAuthenticationParameter.getCurrentConfiguration();

                     if (value.user != basicAuth.user)
                        pageHasToBeReloaded = true;

                     //we check for password modification
                     var newPass = passwordAuthenticationParameter.getCurrentConfiguration();
                     if (newPass != $.md5(fakePassword)) {
                        //the password has been changed
                        value.password = newPass;
                        //we has to reload the page
                        pageHasToBeReloaded = true;
                     }
                     else {
                        //we set the previous one
                        value.password = basicAuth.password;
                     }
                  }
                  else {
                     //the authentication method is inactive
                     value.user = userAuthenticationParameter.getCurrentConfiguration();
                     //we clear the password for the next re-activation
                     value.password = "";
                  }

                  systemConfiguration[ConfigurationManager.items.system.basicAuthentication].value = value;

                  if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.basicAuthentication])) {
                     errorOccurred = true;
                  }

                  //*************
                  //advanced parameters
                  systemConfiguration[ConfigurationManager.items.system.advancedParameters].value = advancedSectionParameters.getCurrentConfiguration().checkbox;

                  if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.advancedParameters])) {
                     errorOccurred = true;
                  }

                  //*************
                  //developerMode
                  systemConfiguration[ConfigurationManager.items.system.developerMode].value = developerModeParameter.getCurrentConfiguration();
                  if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.developerMode])) {
                     errorOccurred = true;
                  }

                  //*************
                  //dateFormatString
                  systemConfiguration[ConfigurationManager.items.system.dateFormatString].value = dateFormatStringParameter.getCurrentConfiguration();
                  if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.dateFormatString])) {
                     errorOccurred = true;
                  }

                  //other system configuration items have to be inserted here
                  //...

                  if (errorOccurred) {
                     //an error has occurred during saving
                     notifyError($.t("modals.dashboard.sub-windows.system-configuration.errorDuringSavingConfiguration"));
                  }
                  else {
                     //we show that configuration has been successfully saved
                     notifySuccess($.t("modals.dashboard.sub-windows.system-configuration.configurationSaved"));
                  }

                  if (pageHasToBeReloaded) {
                     window.location.reload();
                  }
               },
               filter: function() {
                  //we check only control that have class enable-validation and are visible
                  return $(this).is(".enable-validation") && $(this).is(":visible");
               }
            });

            $("button#resetSystemConfiguration").unbind('click').bind('click', function() {
               //we ask for confirmation before resetting all system configuration
               modals.confirmation.load(function() {
                  showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.system-configuration.confirmResetToDefault"),
                       function () {
                          //restore to default has been confirmed

                          var errorOccurred = false;

                          //we get all default values of each parameters on set it as value

                          //*************
                          //language
                          systemConfiguration[ConfigurationManager.items.system.language].value = systemConfiguration[ConfigurationManager.items.system.language].defaultValue;
                          if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.language])) {
                             errorOccurred = true;
                          }
                          else {
                             //we change language of i18n
                             i18n.setLng(systemConfiguration[ConfigurationManager.items.system.language].value, function() {
                                $("html").i18n();
                                moment.lang(systemConfiguration[ConfigurationManager.items.system.language].value);
                             });
                          }

                          //*************
                          //timezone
                          systemConfiguration[ConfigurationManager.items.system.timezone].value = systemConfiguration[ConfigurationManager.items.system.timezone].defaultValue;
                          if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.timezone])) {
                             errorOccurred = true;
                          }

                          //*************
                          //basic authentication
                          systemConfiguration[ConfigurationManager.items.system.basicAuthentication].value = systemConfiguration[ConfigurationManager.items.system.basicAuthentication].defaultValue;
                          if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.basicAuthentication])) {
                             errorOccurred = true;
                          }

                          //*************
                          //advanced parameters
                          systemConfiguration[ConfigurationManager.items.system.advancedParameters].value = systemConfiguration[ConfigurationManager.items.system.advancedParameters].defaultValue;
                          if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.advancedParameters])) {
                             errorOccurred = true;
                          }

                          //*************
                          //developerMode
                          systemConfiguration[ConfigurationManager.items.system.developerMode].value = systemConfiguration[ConfigurationManager.items.system.developerMode].defaultValue;
                          if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.developerMode])) {
                             errorOccurred = true;
                          }

                          //*************
                          //dateFormatString
                          systemConfiguration[ConfigurationManager.items.system.dateFormatString].value = systemConfiguration[ConfigurationManager.items.system.dateFormatString].defaultValue;
                          if (!ConfigurationManager.updateToServerSync(systemConfiguration[ConfigurationManager.items.system.dateFormatString])) {
                             errorOccurred = true;
                          }

                          //other system configuration items have to be inserted here
                          //...

                          if (errorOccurred) {
                             //an error has occurred during saving
                             notifyError($.t("modals.dashboard.sub-windows.system-configuration.errorDuringSavingConfiguration"));
                          }
                          else {
                             //we show that configuration has been successfully saved
                             notifySuccess($.t("modals.dashboard.sub-windows.system-configuration.defaultConfigurationRestored"));
                          }

                          //we ask to reload the modal
                          initializeSystemConfigurationDashboard();
                       });
               });
            });
         }
      });
   }



</script>