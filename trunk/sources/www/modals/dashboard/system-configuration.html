<div id="dashboard-system-configuration">
   <h1 class="page-header"><span class="fa fa-cogs"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.system-configuration.title"></span></h1>
   <form>
      <div class="form-group">
         <!--configuration will be inserted here-->
      </div>
      <div class="modal-footer">
         <div class="form-actions">
            <button id="resetSystemConfiguration" type="button" class="btn btn-default" data-i18n="common.resetToDefault"></button>
            <button type="submit" id="btn-confirm-configure-device" class="btn btn-primary" data-i18n="common.apply"></button>
         </div>
      </div>
   </form>
</div>

<script>
   function initializeSystemConfigurationDashboard() {
      var $modalBody = $("div#dashboard-system-configuration .form-group");
      $modalBody.empty();

      //get current system configuration
      ConfigurationManager.getSection(ConfigurationManager.items.systemSection, function(configuration) {
         if (!isNullOrUndefined(configuration)) {

            var i18nContext = "modals.dashboard.sub-windows.system-configuration.configuration-items.";

            //we create configuration items
            //var authenticationMethodParameter = new EnumParameterHandler(i18nContext, "authenticationMethod", {values:{"none" : ""}}, currentConfiguration.authenticationMethod);
            var developerModeParameter = new BoolParameterHandler(i18nContext, ConfigurationManager.items.system.developerMode, {defaultValue: false}, configuration[ConfigurationManager.items.system.developerMode].value);

            //we create language selection list

            var languageParameter = new EnumParameterHandler(i18nContext, ConfigurationManager.items.system.language, {"values" : isoLanguageCodes, "defaultValue" : language}, configuration[ConfigurationManager.items.system.language].value)

            //we create timezone selection list
            //TODO
            // moment.tz.zones()

            //and add it to the gui
            //$modalBody.append(authenticationMethodParameter.getDOMObject());
            $modalBody.append(languageParameter.getDOMObject());
            $modalBody.append(developerModeParameter.getDOMObject());

            //we i18n the form
            $modalBody.i18n();

            //validation form
            $modalBody.find("input,select,textarea").jqBootstrapValidation({
               preventSubmit: true,
               submitError: function($form, event, errors) {
                  console.warn("Unable to validate form: " + errors);
               },
               submitSuccess: function($form, event) {
                  event.preventDefault();
                  console.debug("End of system Configuration");

                  var errorOccurred = false;

                  //we save current configuration
                  configuration[ConfigurationManager.items.system.developerMode].value = developerModeParameter.getCurrentConfiguration();

                  if (!ConfigurationManager.updateToServerSync(configuration[ConfigurationManager.items.system.developerMode])) {
                     errorOccurred = true;
                  }

                  configuration[ConfigurationManager.items.system.language].value = languageParameter.getCurrentConfiguration();

                  if (!ConfigurationManager.updateToServerSync(configuration[ConfigurationManager.items.system.language])) {
                     errorOccurred = true;
                  }
                  else {
                     language = configuration[ConfigurationManager.items.system.language].value;
                     //we change language of i18n
                     i18n.setLng(language, function() {
                        $("html").i18n();
                     });
                  }

                  //other system configuration items have to be inserted here

                  if (errorOccurred) {
                     //an error has occurred during saving
                     notifyError($.t("modals.dashboard.sub-windows.system-configuration.errorDuringSavingConfiguration"));
                  }
                  else {
                     //we show that configuration has been successfully saved
                     notifySuccess($.t("modals.dashboard.sub-windows.system-configuration.configurationSaved"));
                  }
               },
               filter: function() {
                  //we check only control that have class enable-validation and are visible
                  return $(this).is(".enable-validation") && $(this).is(":visible");
               }
            });

            $("button#resetSystemConfiguration").unbind('click').bind('click', function() {
               //we ask for confirmation before resetting all system configuration
               modals.confirmation.load(function() {
                  showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.system-configuration.confirmResetToDefault"),
                          function () {
                             //restore to default has been confirmed

                             var errorOccurred = false;

                             //we get all default values of each parameters on set it as value

                             configuration[ConfigurationManager.items.system.developerMode].value = configuration[ConfigurationManager.items.system.developerMode].defaultValue;
                             if (!ConfigurationManager.updateToServerSync(configuration[ConfigurationManager.items.system.developerMode])) {
                                errorOccurred = true;
                             }

                             configuration[ConfigurationManager.items.system.language].value = configuration[ConfigurationManager.items.system.language].defaultValue;
                             if (!ConfigurationManager.updateToServerSync(configuration[ConfigurationManager.items.system.language])) {
                                errorOccurred = true;
                             }

                             //other system configuration items have to be inserted here

                             if (errorOccurred) {
                                //an error has occurred during saving
                                notifyError($.t("modals.dashboard.sub-windows.system-configuration.errorDuringSavingConfiguration"));
                             }
                             else {
                                //we show that configuration has been successfully saved
                                notifySuccess($.t("modals.dashboard.sub-windows.system-configuration.defaultConfigurationRestored"));
                             }

                             //we ask to reload the modal
                             initializeSystemConfigurationDashboard();
                          });
               });
            });
         }
      });
   }



</script>