<div id="dashboard-devices">
   <h1 class="page-header"><span class="fa fa-tasks"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.devices.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.devices.deviceListDescription"></span><br>
   <button id="btn-add-new-device" type="button" class="btn btn-success dashboard-btn-new disabled"><span class="fa fa-tasks"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.devices.new"></span></button>
   <table id="device-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.name" class="col-md-2"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.attachedTo" class="col-md-2"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.model" class="long-text col-md-2"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.actions" class="col-md-2"></td>
      </tr>
      <!-- devices will be listed here-->
   </table>
</div>

<script>
   var deviceList = [];
   var periodicDashboardDevicesTaskCounter = 0;

   function initializeDeviceDashboard() {

      //we check if there is at least one plugin instantiated that handle manual creation
      PluginInstanceManager.getPluginInstanceHandleManuallyDeviceCreation(function(list) {
         if (list.length > 0) {
            //there is at least one plugin instance that handle this button
            $("#btn-add-new-device").removeClass("disabled").unbind("click").bind("click", addNewDevice);
         }
      });

      refreshDeviceList();
	  
	 //we use the periodic task of the dashboard
	 clearInterval(periodicDashboardTask);
	 periodicDashboardTask = setInterval(periodicDashboardDevicesTask, 5000);
   }

   function refreshDeviceList() {
      //we remove all rows except header
      $("table#device-list").find("tr:gt(0)").remove();

      //we clear pluginInstance array
      deviceList = [];

       DeviceManager.getAll(function(allDevices) {
           deviceList = allDevices;
           //foreach result we append a <tr>
           $.each(allDevices, function(index, value) {
               addDeviceToDom(value);
           });
       });
   }

   function getDeviceDomRow(device) {
      return $("table#device-list").find("tr[device-id='" + device.id + "']");
   }

   function getDeviceDetailsDomRow() {
      return $("table#device-list").find("tr.device-details");
   }

   function getKeywordDomRow(keyword) {
      return $("table#keyword-list").find("tr[keyword-id='" + keyword.id + "']");
   }

   function addDeviceToDom(device) {
      var actionsBtns = "<div class=\"btn-group\">\n" +
              "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.configure\"><span class=\"fa fa-pencil\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.delete\"><span class=\"fa fa-trash\"></span></button>\n" +
              "</div>";

      var friendlyName = "<span class=\"glyphicon glyphicon-chevron-down deploy\">&nbsp;</span><span>" + decodeURIComponent(device.friendlyName) + "</span>";
      var model = "<span>" + device.model + "</span>";

      //we add it to the DOM
      var $deviceList = $("table#device-list");
      
      $deviceList.append("<tr device-id=\"" + device.id + "\" class=\"device\"><td class=\"device-friendlyName vert-align text-left\"></td><td class=\"device-attachedTo vert-align\"></td><td class=\"device-model vert-align\"></td><td class=\"device-actions vert-align\"></td></tr>");

      var $deviceRow = getDeviceDomRow(device);
      //we fill the data
      $deviceRow.find("td.device-friendlyName").html(friendlyName);
      $deviceRow.find("td.device-model").html(model);

      //we add actions to the device
      $deviceRow.find("td.device-actions").append(actionsBtns);

      //we bind event on the different actions
      $deviceRow.find("button.btn-configure").unbind('click').bind('click', configureDevice(device));
      $deviceRow.find("button.btn-delete").unbind('click').bind('click', deleteDevice(device));

      $deviceRow.unbind('click').bind('click', clickDevice(device));

      $deviceRow.i18n();

      //we async ask for attached plugins
      DeviceManager.getAttachedPlugin(device, function() {
         var $deviceRow = getDeviceDomRow(device);
         var iconName;
         if (!device.attachedPlugin.isSystemCategory()) {
            iconName = "plugins/" + device.attachedPlugin.type + "/icon.png";
         }
         else {
            //we use application logo
            iconName = "img/icon_256.png";
            //we prevent from editing or renaming system devices
            $deviceRow.find("button.btn-configure").addClass("disabled");
            $deviceRow.find("button.btn-delete").addClass("disabled");
         }

         var attachedTo = "<img src=\"" + iconName + "\" class=\"img-thumbnail plugin-icon\">&nbsp;&nbsp;" +
                 "<span>" + device.attachedPlugin.displayName + "</span>";

         $deviceRow.find("td.device-attachedTo").html(attachedTo);
      });
   }

   function configureDevice(device) {
      //device represent the device concerned
      return function(event) {
         event.stopPropagation();
         //we just ask for the friendly name
         modals.deviceConfigure.load(function() {
               showConfigurationDeviceModal(device, function() {
                  DeviceManager.updateToServer(device, function(result) {
                     //We update the information that can have changed after the configuration
                     var $row = getDeviceDomRow(device);
					 
					 var friendlyName = "<span class=\"glyphicon glyphicon-chevron-down deploy\">&nbsp;</span><span>" + decodeURIComponent(device.friendlyName) + "</span>";
                     $row.find("td.device-friendlyName").html( friendlyName );
                  });
               });
         });
      }
   }

   function deleteDevice(device) {
      //device represent the device concerned
      return function(event) {
         event.stopPropagation();
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.devices.confirmDeviceDeletion", {deviceName:device.friendlyName}),
            function () {
               //deletion has been confirmed
               DeviceManager.deleteFromServer(device, function() {
			   
                  //we remove device from array
				  var i = deviceList.map(function(e) { return e.id; }).indexOf( device.id );
                  
                  if(i != -1) {
                     deviceList.splice(i, 1);
					 
					  //we remove device from dom
					  getDeviceDomRow(device).remove();					 
                  }
               });
            });
         });
      }
   }

   function clickDevice(device) {
      //device represent the device concerned
      return function() {
         var $deviceRow = getDeviceDomRow(device);

         var selectedClass = "info";

         //we remove the line that contains keywords information
         var $details = getDeviceDetailsDomRow();
         if (!isNullOrUndefinedOrEmpty($details))
            $details.remove();

         //we look if this device is already selected
         if (!$deviceRow.hasClass(selectedClass)) {
            $deviceRow.siblings(".device").find("span.deploy").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
            //we select the line
            $deviceRow.find("span.deploy").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");
            $deviceRow.addClass(selectedClass).siblings(".device").removeClass(selectedClass);

            //we create device details table
            $deviceRow.after("<tr device-id=\"" + device.id + "\" class=\"device-details " + selectedClass + "\"><td colspan=\"4\">" +
                    "<table id=\"keyword-list\" class=\"table table-bordered table-striped\">" +
                    "<tr>" +
                        "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.name\" class=\"col-md-2\"></td>" +
						"<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.value\" class=\"col-md-2\"></td>" +
                        "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.units\" class=\"col-md-2\"></td>" +
						"<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.update\" class=\"col-md-2\"></td>" +
                        "<td data-i18n=\"modals.dashboard.sub-windows.devices.details.table.actions\" class=\"col-md-2\"></td>" +
                    "</tr>" +
                     <!-- keywords will be listed here-->
                    "</table>" +
                    "</td></tr>");

            var $deviceDetailsTable = $("table#keyword-list");
            $deviceDetailsTable.i18n();

            DeviceManager.getKeywords(device, function() {
               var actionsBtns = "<div class=\"btn-group\">\n" +
                       "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.configure\"><span class=\"fa fa-pencil\"></span></button>\n" +
                       "</div>";

               $.each(device.keywords, function (index, keyword) {
                  $deviceDetailsTable.append("<tr keyword-id=\"" + keyword.id + "\"><td class=\"keyword-friendlyName vert-align\"></td><td class=\"keyword-value vert-align\"><td class=\"keyword-units vert-align\"><td class=\"keyword-update vert-align\"></td><td class=\"keyword-actions vert-align\"></td></tr>");
				  
				  var KeywordValue = "<span></span>";;
				  var LastStateValue = "";
				  
				  AcquisitionManager.getLastValue(keyword.id, function (acquisition) {
					  //Check if the value is a JSON string. In this case this value should not be show
					  try{
					     var jsonString = $.parseJSON(acquisition.value);
					     if (jsonString != null && typeof jsonString != 'object')
					     {
						   // not json
						   KeywordValue = "<span>" + acquisition.value + "</span>";
					     }
					  }
					  catch(err){
					     KeywordValue = "<span>" + acquisition.value + "</span>";
					  } // If catch error, the string is not a JSON String

                 var acquisitionDate = isNullOrUndefinedOrEmpty(acquisition.date) ? $.t("modals.dashboard.sub-windows.devices.noAcquisition") : DateTimeFormatter.isoDateToString(acquisition.date);
					  LastStateValue = "<span>" + acquisitionDate + "</span>";
					   
					  var $keywordRow = getKeywordDomRow(keyword);
					  //we fill the data
					  var friendlyName = "<span>" + decodeURIComponent(keyword.friendlyName) + "</span>";
					  var units = "<span>" + $.t(keyword.units) + "</span>";

					  $keywordRow.find("td.keyword-friendlyName").html(friendlyName);
					  $keywordRow.find("td.keyword-units").html(units);
					  
					  $keywordRow.find("td.keyword-value").html( KeywordValue );
					  $keywordRow.find("td.keyword-update").html( LastStateValue );

					  //we add actions to the keyword
					  $keywordRow.find("td.keyword-actions").append(actionsBtns);

					  //we prevent from renaming keywords on system devices
					  if ((!isNullOrUndefined(device.attachedPlugin)) && (device.attachedPlugin.isSystemCategory())) {
						 $keywordRow.find("button.btn-configure").addClass("disabled");
					  }
					  else {
						 //we bind event on the different actions
						 $keywordRow.find("button.btn-configure").unbind('click').bind('click', configureKeyword(keyword));
					  }	
                   });
               });
            });
         }
         else {
            $deviceRow.removeClass(selectedClass);
            $deviceRow.find("span.deploy").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
         }
      }
   }

   function configureKeyword(keyword) {
      //keyword represent the device concerned
      return function() {
         //we just ask for the friendly name
         modals.keywordConfigure.load(function() {
            showConfigurationKeywordModal(keyword, function() {
               KeywordManager.updateToServer(keyword, function(result) {
                  //We update the information that can have changed after the configuration
                  var $row = getKeywordDomRow(keyword);
                  $row.find("td.keyword-friendlyName").html(keyword.friendlyName);
               });
            });
         });
      }
   }

   function addNewDevice() {
      modals.deviceAddManually.load(function() {
         askPluginTypesForManuallyDeviceCreation(function(pi) {
            //we get package.json
            PluginInstanceManager.downloadPackage(pi, function() {
               //we ask for configuration modal async
               modals.deviceConfigureManually.load(function() {
                  //we launch configureInstance GUI
                  showConfigurationManuallyDeviceModal(pi, function (newDeviceName, newDeviceConfiguration) {
                     //we ask for manually device creation
                     PluginInstanceManager.createManuallyDevice(pi, newDeviceName, newDeviceConfiguration, function() {
                        refreshDeviceList();
                     });
                  });
               });
            });
         });
      });
   }
   
   function periodicDashboardDevicesTask() {
      //periodically we check the status of each plugin
      if (serverIsOnline) 
	  {
		   //Check for new devices
		   DeviceManager.getAll(function(allDevices) {
		      //Only if the number of devices is different, we check which one
            if (deviceList.length != allDevices.length)
            {
               //foreach result we append a <tr>
               $.each(allDevices, function(index, value)
               {
                  var i = deviceList.map(function(e) { return e.id; }).indexOf( value.id );

                  // If not in the list, we add to the list, and to the dom
                  if (i == -1) {
                    deviceList.push ( value );
                    addDeviceToDom  ( value );
                  }
               });
            }
         });
	  
	      $.each(deviceList, function(index, value) {
            var selectedClass = "info";
  			   var $deviceRow = getDeviceDomRow(value);
			
            var $deviceDetailsTable = $("table#keyword-list");
            $deviceDetailsTable.i18n();
			
			  if ($deviceRow.hasClass(selectedClass)) {
               $.each(value.keywords, function (index, keyword) {

                  AcquisitionManager.getLastValue(keyword.id, function (acquisition) {

                     var $keywordRow = getKeywordDomRow(keyword);

                     //This keyword is new -> Create the line and fill units and friendly Name
                     if ($keywordRow == undefined)
                     {
                        $deviceDetailsTable.append("<tr keyword-id=\"" + keyword.id + "\"><td class=\"keyword-friendlyName vert-align\"></td><td class=\"keyword-value vert-align\"><td class=\"keyword-units vert-align\"><td class=\"keyword-update vert-align\"></td><td class=\"keyword-actions vert-align\"></td></tr>");
                        $keywordRow = getKeywordDomRow(keyword);

                        var $keywordRow = getKeywordDomRow(keyword);
                        //we fill the data
                        var friendlyName = "<span>" + decodeURIComponent(keyword.friendlyName) + "</span>";
                        var units = "<span>" + $.t(keyword.units) + "</span>";

                        $keywordRow.find("td.keyword-friendlyName").html(friendlyName);
                        $keywordRow.find("td.keyword-units").html(units);
                     }

                       var KeywordValue = "<span></span>";
                       var LastStateValue = "";

                       //Check if the value is a JSON string. In this case this value should not be show
                       try
                       {
                          var jsonString = $.parseJSON(acquisition.value);

                          if (jsonString != null && typeof jsonString != 'object')
                         {
                          // not json
                          KeywordValue = "<span>" + acquisition.value + "</span>";
                         }
                       }
                       catch(err){
                          KeywordValue = "<span>" + acquisition.value + "</span>";
                       } // If catch error, the string is not a JSON String

                       var acquisitionDate = isNullOrUndefinedOrEmpty(acquisition.date) ? $.t("modals.dashboard.sub-windows.devices.noAcquisition") : DateTimeFormatter.isoDateToString(acquisition.date);
                       LastStateValue = "<span>" + acquisitionDate + "</span>";

                       $keywordRow.find("td.keyword-value").html( KeywordValue );
                       $keywordRow.find("td.keyword-update").html( LastStateValue );
                     });
                  });
               }
           });
      }
   }   
   
</script>