<div id="dashboard-devices">
   <h1 class="page-header"><span class="fa fa-tasks"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.devices.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.devices.deviceListDescription"></span><br>
   <button id="btn-add-new-device" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-rocket"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.devices.new"></span></button>
   <table id="device-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.name"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.attachedTo"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.model"></td>
         <td data-i18n="modals.dashboard.sub-windows.devices.table.actions"></td>
      </tr>
      <!-- devices will be listed here-->
   </table>
</div>

<script>
   var deviceList = [];

   function initializeDeviceDashboard() {
      //we remove all rows except header
      $("table#device-list").find("tr:gt(0)").remove();
      //we clear pluginInstance array
      deviceList = [];

      $("#btn-add-new-device").unbind("click").bind("click", addNewDevice);

      //we dynamically ask for devices
      $.getJSON("/rest/plugin/device")
         .done(function (data) {
            //we parse the json answer
            if (data.result != "true")
            {
               notifyError($.t("modals.dashboard.sub-windows.devices.errorGettingDeviceList"), JSON.stringify(data));
               return;
            }
            //foreach result we append a <tr>
            $.each(data.data.device, function(index, value) {
               var dev = new Device(value.id, value.pluginId, value.name, value.friendlyName, value.model);
               deviceList.push(dev);
               addDeviceToDom(dev);
            });

            //we don't use the periodic task of the dashboard
            clearInterval(periodicDashboardTask);
         })
         .fail(function() {notifyError($.t("modals.dashboard.sub-windows.devices.errorGettingDeviceList"), JSON.stringify(data));});
   }
   
   function addDeviceToDom(device) {
      var actionsBtns = "<div class=\"btn-group\">\n" +
              "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.configure\"><span class=\"glyphicon glyphicon-cog\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.devices.delete\"><span class=\"glyphicon glyphicon-trash\"></span></button>\n" +
              "</div>";

      var friendlyName = "<span>" + device.friendlyName + "</span>";
      var model = "<span>" + device.model + "</span>";

      //we add it to the DOM
      var $deviceList = $("table#device-list");

      $deviceList.append("<tr device-id=\"" + device.id + "\"><td class=\"device-friendlyName\"></td><td class=\"device-attachedTo\"></td><td class=\"device-model\"></td><td class=\"device-actions\"></td></tr>");

      var $deviceRow = $deviceList.find("tr[device-id='" + device.id + "']");
      //we fill the data
      $deviceRow.find("td.device-friendlyName").html(friendlyName);
      $deviceRow.find("td.device-model").html(model);

      //we add actions to the device
      $deviceRow.find("td.device-actions").append(actionsBtns);

      //we bind event on the different actions
      $deviceRow.find("button.btn-configure").unbind('click').bind('click', configureDevice(device));
      $deviceRow.find("button.btn-delete").unbind('click').bind('click', deleteDevice(device));
      
      //we async ask for attached device
      //TODO
      
      $deviceRow.find("td.device-attachedTo").html(attachedTo);
      var attachedPlugin = "<img src=\"device/" + pi.type + "/icon.png\" class=\"img-thumbnail device-icon\">&nbsp;&nbsp;" +
                  "<span>" + pi.type + "</span>";
   }
   
   function configureDevice(device) {
      //device represent the device concerned
      return function() {
         //we get package.json
         DeviceManager.getAttachedPlugin(device, function() {
            //TODO
            modals.deviceConfigure.load(function() {
               configureDevice(device, function() {
                  DeviceManager.updateToServer(device, function(result) {
                  });
               });
            });
         });
      }
   }

   function deleteDevice(device) {
      //device represent the device concerned
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.devices.confirmDeviceDeletion", {deviceName:device.friendlyName}),
            function () {
               //deletion has been confirmed
               DeviceManager.deleteFromServer(device, function() {
                  //we remove device from array
                  var i = deviceList.indexOf(device);
                  if(i != -1) {
                     deviceList.splice(i, 1);
                  }

                  //we remove device from dom
                  $("table#device-list").find("tr[device-id='" + device.id + "']").remove();
               });
            });
         });
      }
   }
   
   function addNewDevice() {
   
   }
   
</script>