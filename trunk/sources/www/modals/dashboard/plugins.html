<div id="dashboard-plugins">
   <h1 class="page-header"><span class="fa fa-rocket"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.plugins.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.plugins.pluginInstanceListDescription"></span><br>
   <button id="btn-add-new-plugin" type="button" class="btn btn-success"><span class="fa fa-rocket"></span>&nbsp;&nbsp;<span>Instantiate a new plugin</span></button>
   <table id="plugin-instance-list" class="table table-bordered table-striped">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.name"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.pluginName"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.status"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.launchAtStartup"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.actions"></td>
      </tr>
      <!-- plugin instance will be listed here-->
   </table>
</div>
<script>
   var pluginInstanceList = [];

   function initializePluginDashboard() {
      //we remove all rows except header
      $("table#plugin-instance-list").find("tr:gt(0)").remove();
      //we clear pluginInstance array
      pluginInstanceList = [];

      //we dynamically ask for plugins
      $.getJSON("/rest/plugin/instances")
         .done(function (data) {
            //we parse the json answer
            if (data.result != "true")
            {
               notifyError($.t("modals.dashboard.sub-windows.plugins.errorGettingPluginList"), JSON.stringify(data));
               return;
            }

            //foreach result we append a <tr>
            $.each(data.data.plugin, function(index, value) {
               var pi = new PluginInstance(value.id, value.name, value.pluginName, value.configuration, value.enabled);
               pluginInstanceList.push(pi);
               addPluginInstanceToDom(pi);
            });

            //we use the periodic task of the dashboard
            clearInterval(periodicDashboardTask);
            periodicDashboardTask = setInterval(periodicDashboardPluginTask, 1000);
            periodicDashboardPluginTask();
         })
         .fail(function() {notifyError($.t("modals.dashboard.sub-windows.plugins.errorGettingPluginList"), JSON.stringify(data));});
   }

   function addPluginInstanceToDom(pi) {
      var actionsBtns = "<div class=\"btn-group\">\n" +
              "<button type=\"button\" class=\"btn btn-startStop\"><span class=\"glyphicon glyphicon-off\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.configure\"><span class=\"glyphicon glyphicon-cog\"></span></button>\n" +
              "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.delete\"><span class=\"glyphicon glyphicon-trash\"></span></button>\n" +
              "</div>";

      var autoStartCommand = "<input type=\"checkbox\">";

      var statusField = "<span class=\"label label-success label-status\"></span>\n";/* +
              "&nbsp;&nbsp;" +
              "<button type=\"button\" class=\"btn btn-startStop\"></button>";*/

      //we add it to the DOM
      $("table#plugin-instance-list").append("<tr plugin-id=\"" + pi.id + "\"><td class=\"plugin-name\"></td><td class=\"plugin-pluginName\"></td><td class=\"plugin-status\"></td><td class=\"plugin-autoStart\"></td><td class=\"plugin-actions\"></td></tr>");
      //we fill the data
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-name").text(pi.name);
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-pluginName").text(pi.pluginName);
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-autoStart").html(autoStartCommand);
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-status").html(statusField);

      //we add actions to the plugin
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-actions").append(actionsBtns);

      //we bind event on the different actions
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("button.btn-startStop").unbind('click').bind('click', startStopPlugin(pi));
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("button.btn-configure").unbind('click').bind('click', configurePlugin(pi));
      $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("button.btn-delete").unbind('click').bind('click', deletePlugin(pi));
   }

   function startStopPlugin(pi) {
      //pi represent the pluginInstance concerned
      return function() {
         if (pi.lastRunningStatus) {
            //we ask for stop
            pi.stop();
         }
         else
         {
            //we ask for start
            pi.start();
         }
      }
   }

   function configurePlugin(pi) {
      //pi represent the pluginInstance concerned
      return function() {

      }
   }

   function deletePlugin(pi) {
      //pi represent the pluginInstance concerned
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.plugins.confirmPluginDeletion", {pluginName:pi.name}),
            function () {
               //deletion has been confirmed
               pi.deleteFromServer(function() {
                  //we remove pi from array
                  var i = pluginInstanceList.indexOf(pi);
                  if(i != -1) {
                     pluginInstanceList.splice(i, 1);
                  }

                  //we remove pi from dom
                  $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").remove();
               });
            });
         });
      }
   }

   function periodicDashboardPluginTask() {
      //periodically we check the status of each plugin
      if (serverIsOnline) {
         $.each(pluginInstanceList, function(index, value) {
            //we ask async for the status
            value.getStatus(function (status) {
               if (status != value.lastRunningStatus) {
                  var textStatus = "";
                  var btn;
                  var label;
                  if(status) {
                     //$("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("span.label-status").addClass("label-success").removeClass("label-danger").text($.t("modals.dashboard.sub-windows.plugins.running"));
                     //$("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("button.btn-startStop").addClass("btn-danger").removeClass("btn-success").text($.t("modals.dashboard.sub-windows.plugins.stop"));
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("span.label-status").addClass("label-success").removeClass("label-danger").text($.t("modals.dashboard.sub-windows.plugins.running"));
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("button.btn-startStop").addClass("btn-warning").removeClass("btn-success");
                  }
                  else {
                     //$("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("span.label-status").addClass("label-danger").removeClass("label-success").text($.t("modals.dashboard.sub-windows.plugins.stopped"));
                     //$("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("button.btn-startStop").addClass("btn-success").removeClass("btn-danger").text($.t("modals.dashboard.sub-windows.plugins.start"));
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("span.label-status").addClass("label-danger").removeClass("label-success").text($.t("modals.dashboard.sub-windows.plugins.stopped"));
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("button.btn-startStop").addClass("btn-success").removeClass("btn-warning");
                  }
               }
            });
         });
      }
   }

   $("#btn-add-new-plugin").click(function() {
      modals.pluginAdd.load(function() {askPluginTypes();});
   });
</script>
