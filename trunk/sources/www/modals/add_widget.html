<link href="../css/add_widget.css" rel="stylesheet">

<!--New widget Modal -->
<div class="modal fade" id="new-widget-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel" data-i18n="modals.add-widget.title">Add a new Widget</h4>
            </div>
            <div class="modal-body">
                <div id="new-widget-carousel" class="carousel slide">

                    <!-- Wrapper for slides -->
                    <div class="carousel-inner">
                        <!-- widgets types will be inserted here -->
                    </div>

                    <!-- Controls -->
                    <a class="left carousel-control" href="#new-widget-carousel" data-slide="prev">
                        <span class="icon-prev"></span>
                    </a>
                    <a class="right carousel-control" href="#new-widget-carousel" data-slide="next">
                        <span class="icon-next"></span>
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-get-more-widget" type="button" class="btn btn-primary pull-left" data-i18n="modals.add-widget.getMore">Get more widget</button>
                <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel">Cancel</button>
                <button id="btn-confirm-add-widget" type="button" class="btn btn-primary" data-i18n="common.ok">Add new</button>
            </div>
        </div>
    </div>
</div>

<script>

    var packages = [];

    /**
     * Ask for widget packages to the REST server
     */
    function askWidgetPackages()
    {
       $.getJSON("rest/widget/package")
               .done(requestWidgetsTypeDone())
               .fail(function() {notifyError($.t("modals.add-widget.errorDuringGettingPackages"));});
    }

    /**
     * Callback of the request widget packages
     * @returns {Function}
     */
    function requestWidgetsTypeDone()
    {
       return function( data ) {
          //we parse the json answer
          if (data.result != "true")
          {
             notifyError($.t("modals.add-widget.errorDuringGettingPackages"), JSON.stringify(data));
             return;
          }
          $("div#new-widget-carousel > div.carousel-inner > div").remove();
          //noinspection JSUnusedLocalSymbols
          $.each(data.data.package, function(index, value) {
             //foreach widget-type
             packages[value.name] = value;
             //carousel item creation
             var i18ncontext = value.name + ":";
             $("div#new-widget-carousel > div.carousel-inner").append(
                     "<div class=\"item\" package=\"" + value.name + "\" >" +
                             "<img class=\"carousel-widget-preview\" src=\"/widgets/" + value.name + "/preview.png\">" +
                             "<div class=\"carousel-caption\" data-i18n=\"" + i18ncontext + "description\">" +
                                 value.description +
                             "</div>" +
                     "</div>"
             );
          });

          $("div#new-widget-carousel").i18n();

          //we activate first item of carousel
          $("div#new-widget-carousel div.item").first().addClass("active");

          $('div.carousel').carousel('pause');

          //we display the modal
          $('div#new-widget-modal').modal();
       };
    }

    /**
     * Callback to the click of the button to confirm an add of a new widget
     */
    $("button#btn-confirm-add-widget").click(function () {

       var currentPage = PageManager.getCurrentPage();
       assert(!isNullOrUndefined(currentPage), "A page must be selected");

       //we close the new widget modal
       $("div#new-widget-modal").modal("hide");

       var packageName = $('div#new-widget-carousel div.active').attr("package");

       //we get default size of the widget
       var minX = 1;
       var minY = 1;
       if (packages[packageName].dimensions.min !== undefined)
       {
          minX = packages[packageName].dimensions.min.x;
          minY = packages[packageName].dimensions.min.y;
       }

       var maxX = Infinity;
       var maxY = Infinity;
       if (packages[packageName].dimensions.max !== undefined)
       {
          maxX = packages[packageName].dimensions.max.x;
          maxY = packages[packageName].dimensions.max.y;
       }

       var defaultX = 1;
       var defaultY = 1;
       if (packages[packageName].dimensions.default !== undefined)
       {
          defaultX = packages[packageName].dimensions.default.x;
          defaultY = packages[packageName].dimensions.default.y;
       }

       var sizeX = Math.min(maxX, Math.max(defaultX, minX));
       var sizeY  = Math.min(maxY, Math.max(defaultY, minY));

       //we create a fake widget to display configuration form
       var newWidget = new Widget(-1, currentPage.id, packageName, sizeX, sizeY, 1, 1, "");

       newWidget.package = WidgetPackageManager.widgetPackages[newWidget.name].packageInformation;

       modals.widgetConfiguration.load(function() {

           configureWidget(newWidget, function () {
               //if the configuration has been validated we can create the widget
               $.ajax({
                   type: "POST",
                   url: "/rest/widget",
                   data: JSON.stringify({ idPage: newWidget.idPage, name: newWidget.name, sizeX: newWidget.sizeX, sizeY: newWidget.sizeY, positionX: newWidget.positionX, positionY: newWidget.positionY, configuration: newWidget.configuration }),
                   contentType: "application/json; charset=utf-8",
                   dataType: "json"
               })
               .done(function(data) {
                   //we parse the json answer
                   if (data.result != "true")
                   {
                       notifyError($.t("modals.add-widget.errorDuringCreatingWidget"), JSON.stringify(data));
                       return;
                   }

                   notifySuccess($.t("modals.add-widget.widgetSuccessfullyCreated"));
                     debugger;
                   //we add the widget dynamically
                   var w = WidgetManager.factory(data.data);
                   WidgetManager.loadWidgetList([w]);
               })
               .fail(function(widgetName) { return function() {notifyError($.t("modals.add-widget.unableToCreateWidgetOfType", {"widgetType" : widgetName}))}}(packageName));
           });
       });
    });

</script>