<!--Edit automation Rule Modal -->
<div class="modal fade" id="automation-rule-new-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog automation-rule-new-modal">
        <div class="modal-content">
           <form class="form-horizontal" novalidate >
              <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                   <h4 class="modal-title" data-i18n="modals.new-automation-rule.title"></h4>
              </div>
              <div class="modal-body form-group">
                   <h4 data-i18n="modals.new-automation-rule.from-scratch"></h4>
                   <span data-i18n="modals.new-automation-rule.choose-language"></span>
                   <div class="language-btns"></div>
                   <h4 data-i18n="modals.new-automation-rule.from-model"></h4>
                   <span data-i18n="modals.new-automation-rule.choose-model"></span>
                   <div class="models-btns"></div>
              </div>
              <div class="modal-footer">
                 <div class="form-actions">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel"></button>
                 </div>
              </div>
           </form>
        </div>
    </div>
</div>

<script>
   var BlocklyName = "blockly";

   function showNewAutomationRule(callback) {
      assert($.isFunction(callback), "callback must be defined");

      var $modalBody = $("div#automation-rule-new-modal .modal-body");

      //TODO V2 : request languages
      var languageList = [];
      languageList.push({"name":"python"});

      //we create buttons to select language
      var $area = $modalBody.find("div.language-btns");

      $area.append("<button class=\"btn btn-primary btn-lg btn-blockly\" type=\"button\">" +
      "<span class=\"fa fa-puzzle-piece\"></span>&nbsp;&nbsp;" +
      BlocklyName + "</button>");

      $.each(languageList, function (key, value) {
         $area.append("<button language=\"" + value.name + "\" class=\"btn btn-primary btn-lg btn-language\" type=\"button\">" +
         "<span class=\"fa fa-code\"></span>&nbsp;&nbsp;" +
         value.name + "</button>");
      });

      //we listen for click events
      $area.find("button.btn-blockly").unbind("click").bind("click", function (object) {
         //we go to blockly edition
         var r = new AutomationRule(-1, "", "", BlocklyName, "", "", "", true);
         //todo charger la modale
         showEditionAutomationRuleWithBlockly(r, function() {
            AutomationRuleManager.createToServer(r);
         });
      });

      $area.find("button.btn-language").unbind("click").bind("click", function (object) {
         //we check for the language
         var lng = $(this).attr("language");
         //we create the empty rule and go to edition
         var r = new AutomationRule(-1, "", "", lng, "", "", "", true);
         modals.automationRuleEditCode.load(function() {
            showEditionAutomationRuleWithCode(r, function () {
               AutomationRuleManager.createToServer(r);
            });
         });
      });

      //TODO V2 : request models

      var modelList = [];

      modelList.push({"name" : "If Then", "description" : "Simple If Then rule model", "language" : BlocklyName, "content" : "<xml>if then</xml>"});
      modelList.push({"name" : "If Then Else", "description" : "Full If Then Else rule model", "language" : BlocklyName, "content" : "<xml>if then else</xml>"});

      $area = $modalBody.find("div.models-btns");

      $.each(modelList, function (key, value) {
         var btn = "<button content=\"" + value.content + "\" class=\"btn btn-primary btn-lg btn-model\" type=\"button\">" +
                     "<div>" +
                        "<h3>" + value.name + "</h3>" +
                        "<h4>" + value.description + "</h4>" +
                     "</div>";
         if (value.language == BlocklyName)
            btn +=   "<h5 class=\"pull-right language\"><span class=\"fa fa-puzzle-piece\"></span>&nbsp;&nbsp;";
         else
            btn +=   "<h5 class=\"pull-right language\"><span class=\"fa fa-code\"></span>&nbsp;&nbsp;";

         btn +=         value.language + "</h5>" +
                   "</button>";

         $area.append(btn);
      });

      //i18n
      $modalBody.i18n();

      //validation form
      $modalBody.find("input,select,textarea").jqBootstrapValidation({
         preventSubmit: true,
         submitError: function($form, event, errors) {
            console.warn("Unable to validate form: " + errors);
         },
         submitSuccess: function($form, event) {
            event.preventDefault();


            console.debug("End of Automation Rule edition : " + JSON.stringify(rule));

            $modalBody.find("input,select,textarea").jqBootstrapValidation("destroy");
            $modalBody.empty();
            $("div#edit-automation-rule-modal").modal("hide");
            callback();
         },
         filter: function() {
            //we check only control that have class enable-validation and are visible
            return $(this).is(".enable-validation") && $(this).is(":visible");
         }
      });

      //we display the modal
      $('div#automation-rule-new-modal').modal();
   }
</script>