<!--Edit automation Rule Modal -->
<div class="modal fade" id="edit-automation-rule-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog edit-automation-rule-modal">
        <div class="modal-content">
           <form class="form-horizontal" novalidate >
              <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                   <h4 class="modal-title" data-i18n="modals.edit-automation-rule.title"></h4>
              </div>
              <div class="modal-body form-group">
                 <h4>
                    <span class="fa fa-question"></span>&nbsp;
                    <span data-i18n="modals.edit-automation-rule.condition"></span>
                 </h4>
                 <span data-i18n="modals.edit-automation-rule.conditionDescription"></span><br>
                 <div class="well">
                    <span id="automationRuleLiteralCondition"><b>if</b> A > 2 <b>then</b> B = 3</span>
                    <div class="row">
                       <div class="automation-rule well col-md-6">
                          <ul class="automation-rule-sub-item automation-rule-first-item">
                             <!--<li>
                                <span><i class="glyphicon glyphicon-asterisk"></i> And</span>
                                <ul>
                                   <li>
                                      <span><i class="glyphicon glyphicon-plus"></i> Or</span>
                                      <ul>
                                         <li>
                                            <span><i class="glyphicon glyphicon-export"></i> temperature of Room sensor goes up to 22 °C</span>
                                         </li>
                                         <li>
                                            <span><i class="glyphicon glyphicon-export"></i> temperature of Kitchen sensor goes up to 23 °C</span>
                                         </li>
                                      </ul>
                                   </li>
                                   <li>
                                      <span><i class="glyphicon glyphicon-saved"></i> active of Alarm is on</span>
                                   </li>
                                </ul>
                             </li>-->
                          </ul>
                       </div>
                       <div class="well col-md-6" id="automation-rule-configuration"></div>
                    </div>
                 </div>
                 <h4>
                    <span class="fa fa-list-ul"></span>&nbsp;
                    <span data-i18n="modals.edit-automation-rule.actions"></span>
                 </h4>
                 <span data-i18n="modals.edit-automation-rule.actionsDescription"></span><br>
                 <div class="well">

                 </div>
              </div>
              <div class="modal-footer">
                 <div class="form-actions">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel"></button>
                    <button type="submit" id="btn-confirm-configure-keyword" class="btn btn-primary" data-i18n="common.ok"></button>
                 </div>
              </div>
           </form>
        </div>
    </div>
</div>

<script>
   var currentAutomationRuleCondition;
   var activeAutomationRuleCondition;

   function showEditionAutomationRule(rule, callback) {
      assert(!isNullOrUndefined(rule), "rule must be defined");
      assert($.isFunction(callback), "callback must be defined");

      var $modalBody = $("div#edit-automation-rule-modal .modal-body");

      //TODO : remove static add
      var conf =
      {
         "and" : {
            "children" : [
               {
                  "is": {
                     "operator": "greater",
                     "keywordId": "11",
                     "refValue": "18"
                  }
               },
               {
                  "is": {
                     "operator": "greater",
                     "keywordId": "12",
                     "refValue": "18"
                  }
               }
            ]
         }
      };

      //currentAutomationRuleCondition = AutomationRuleConditionFactory.createItem(tmp);

      var $field = $("ul.automation-rule-first-item");

      $field.empty();

      var item = new AutomationRuleTreeviewItem(conf);
      //item.operator = currentAutomationRuleCondition;

      item.operatorChanged = function (treeviewItem, newOperator) {

      };

      item.selected = function (treeviewItem) {
         //we set rule as activate
         AutomationRuleHelper.setRuleAsActivated(treeviewItem);
         //we can display its configuration
         var $configurationDiv = $("div#automation-rule-configuration");
         $configurationDiv.empty();
         treeviewItem.operator.displayConfiguration($configurationDiv);
      };

      item.addToDom($field);
/*
      AutomationRuleHelper.createTreeViewItem(currentAutomationRuleCondition, $condition,
              function (operator) {

              },
              function (operator) {
                 debugger;
                 var uuid = $(this).attr("conditionItemId");
                 var rule = currentAutomationRuleCondition.findRule(uuid);
                 if (!isNullOrUndefined(rule)) {
                    //we have find the item
                    activeAutomationRuleCondition = rule;
                    //we set rule as activate
                    AutomationRuleHelper.setRuleAsActivated(rule);
                    //we can display its configuration
                    var $configurationDiv = $("div#automation-rule-configuration");
                    $configurationDiv.empty();
                    rule.displayConfiguration($configurationDiv);
                 }
              });

      currentAutomationRuleCondition.locateInDOM().bind("click", function () {

      });*/

      //i18n
      $modalBody.i18n();

      //validation form
      $modalBody.find("input,select,textarea").jqBootstrapValidation({
         preventSubmit: true,
         submitError: function($form, event, errors) {
            console.warn("Unable to validate form: " + errors);
         },
         submitSuccess: function($form, event) {
            event.preventDefault();


            console.debug("End of Automation Rule edition : " + JSON.stringify(rule));

            $modalBody.find("input,select,textarea").jqBootstrapValidation("destroy");
            $modalBody.empty();
            $("div#edit-automation-rule-modal").modal("hide");
            callback();
         },
         filter: function() {
            //we check only control that have class enable-validation and are visible
            return $(this).is(".enable-validation") && $(this).is(":visible");
         }
      });

      //we display the modal
      $('div#edit-automation-rule-modal').modal();
   }
</script>