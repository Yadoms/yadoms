<div id="dashboard-install-update">
   <h1 class="page-header"><span class="glyphicon glyphicon-save">&nbsp;<span data-i18n="modals.dashboard.sub-windows.install-update.title"></span></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.install-update.description"></span><br>

   <div class="row">
      <div class="col-md-6 pull-right">
         <span data-i18n="modals.dashboard.sub-windows.install-update.releaseTypeChoice"></span>
         <select class="form-control cb-release-type">
            <option value="stable" data-i18n="modals.dashboard.sub-windows.install-update.releaseType.stable"></option>
            <option value="testing" data-i18n="modals.dashboard.sub-windows.install-update.releaseType.testing"></option>
            <option value="beta" data-i18n="modals.dashboard.sub-windows.install-update.releaseType.beta"></option>
         </select>
      </div>
   </div>

   <h2>
      <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.title"></span>
      &nbsp;
      <button id="btn-update-yadoms" type="button" class="btn btn-success disabled">
         <span class="fa fa-download"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.update"></span>
      </button>
   </h2>

   <table id="software-install-update" class="table table-bordered dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.install-update.yadoms.currentVersion" class="active"></td>
         <td class="current-version"><em>v1.12 Beta</em></td>
      </tr>
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.install-update.yadoms.availableVersion" class="active"></td>
         <td class="available-version"><em>v1.14 Beta</em></td>
      </tr>
   </table>

   <h2 data-i18n="modals.dashboard.sub-windows.install-update.plugins.title"></h2>

   <table id="plugin-install-update-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
         <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
         <td class = "col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
         <td class = "col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
         <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
      </tr>
      <!-- plugins will be listed here-->
      <tr colspan="6" data-i18n="objects.generic.retrievingData"></tr>
      </tr>
   </table>

   <h2 data-i18n="modals.dashboard.sub-windows.install-update.widgets.title"></h2>

   <table id="widget-install-update-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
         <td class="install-update-action-row" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
      </tr>
      <!-- widgets will be listed here-->
      <tr colspan="6" data-i18n="objects.generic.retrievingData"></tr>
   </table>

   <h2 data-i18n="modals.dashboard.sub-windows.install-update.script-interpreters.title"></h2>

   <table id="script-interpreters-install-update-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
         <td data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
         <td class="install-update-action-row" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
      </tr>
      <!-- script interpreters will be listed here-->
      <tr colspan="6" data-i18n="objects.generic.retrievingData"></tr>
   </table>
</div>

<script>

   var pluginList;
   var wantedVersion = [/*"beta", "testing", */"stable"];

   var $cbReleaseType = $("div#dashboard-install-update select.cb-release-type");


   function initializeInstallUpdateDashboard() {

      //we listen for change of release type list
      $cbReleaseType.unbind("change").bind("change", function() {
         $cbReleaseType.addClass("disabled");
         //we get the new list depend on the release type selected

         updateReleaseType();
         //we can re-ask the update of the list
         fillPluginList();
      });

      updateReleaseType();
      fillPluginList();
   }

   /**
    * Permit to update wantedVersion array from the combo box release type
    */
   function updateReleaseType() {
      switch ($cbReleaseType.val().toLowerCase()) {
         case "beta" :
            wantedVersion = ["beta", "testing", "stable"];
            break;
         case "testing" :
            wantedVersion = ["testing", "stable"];
            break;
         default:
         case "stable" :
            wantedVersion = ["stable"];
            break;
      }
   }

   /**
    * This function fill the plugin list from the server elements
    */
   function fillPluginList() {
      //we remove all rows except header
      $("table#plugin-install-update-list").find("tr:gt(0)").remove();

      //we launch requests
      PluginManager.get(function(localList) {
         console.log(localList);
         UpdateInformationManager.getPluginList(function(serverList) {
            //we get installed plugin List
            if (serverList) {
               //we merge the two lists
               $.each(serverList, function(serverIndex, serverValue) {
                  //we search it on the other list
                  var itemFound = false;
                  $.each(localList, function(localIndex, localValue) {
                     if (serverValue[0].name.toLowerCase() == localValue.name.toLowerCase()) {
                        //we've found the item
                        itemFound = true;
                        //we add informations of all version that user wants
                        localValue.serverVersions = [];
                        //we browse all version of that item
                        $.each(serverValue, function(versionIndex, versionValue) {
                           //if this releasetype is wanted we add it to the arrays of version for this item
                           if ($.inArray(versionValue.version.toLowerCase(), wantedVersion)) {
                              var item = {};
                              item.downloadUrl = versionValue.downloadUrl;
                              item.version = versionValue.version;
                              item.releaseType = versionValue.releaseType;
                              localValue.serverVersions.push(item);
                           }
                        });
                     }
                  });

                  if (!itemFound) {
                     //we add the new item available only on the server
                     var canAddOnThePage = false;

                     serverValue.sort(UpdateInformationManager.compareVersion);

                     var newItem = {};

                     //generic informations
                     newItem.name = serverValue[0].name;
                     newItem.description = serverValue[0].description;
                     newItem.author = serverValue[0].author;
                     newItem.url = serverValue[0].url;
                     newItem.iconUrl = serverValue[0].iconUrl;

                     //we add informations of all version that user wants
                     newItem.serverVersions = [];
                     //we browse all version of that item
                     $.each(serverValue, function(versionIndex, versionValue) {
                        var item = {};
                        item.downloadUrl = versionValue.downloadUrl;
                        item.version = versionValue.version;
                        item.releaseType = versionValue.releaseType;
                        newItem.serverVersions.push(item);
                        //we need only one release type available in tthe wanted array to can see the whole line
                        if ($.inArray(item.releaseType.toLowerCase(), wantedVersion) > -1)
                           canAddOnThePage = true;
                     });

                     if (canAddOnThePage)
                        localList.push(newItem);
                  }
               });
            }

            //we save it
            pluginList = localList;
            //we display the result
            $.each(pluginList, function(localIndex, localValue) {
               localValue.uid = createUUID();
               //the actual plugin does nothing
               localValue.processing = false;
               createInstallUpdateItemLine(localValue);
               //we set the visibility to the allowed buttons
               updateLine(localValue);
            });

            //we enable the release type list
            $cbReleaseType.removeClass("disabled");
         });
      });
   }

   function createInstallUpdateItemLine(item) {
      var actionsBtns = "<div class=\"btn-group\">\n";
      var s = "<tr id=\"" + item.uid + "\">" +
                  "<td><span>" + item.name + "</span></td>" +
                  "<td><img src=\"" + (item.iconUrl?item.iconUrl:"plugins/" + item.name + "/icon.png") + "\" class=\"img-thumbnail plugin-icon\"></td>" +
                  "<td><span>" + item.description + "</span></td>" +
                  "<td><em class=\"local-version\"></em></td>" +
                  "<td><em class=\"latest-version\"></em></td>" +
                  "<td>" +
                     "<div class=\"action-buttons btn-group\">" +
                       "<div class=\"btn-group btn-install\">" +
                           "<button type=\"button\" class=\"btn main-btn btn-primary\">" +
                              "<span class=\"glyphicon glyphicon-save \"></span>" +
                              "<span class=\"latest-installable-version\"></span>" +
                           "</button>" +
                           "<button type=\"button\" class=\"btn dropdown-toggle btn-expand btn-primary\" data-toggle=\"dropdown\" aria-expanded=\"false\">" +
                              "<span class= \"caret\"></span>" +
                              "<span class=\"sr-only\">Toggle Dropdown</span>" +
                           "</button>" +
                           "<ul class=\"dropdown-menu versions\" role=\"menu\">" +
                           "</ul>" +
                        "</div>" +
                       "<button type=\"button\" class=\"btn btn-danger btn-uninstall\" data-i18n=\"[title]modals.dashboard.sub-windows.install-update.generic.uninstall\"><span class=\"glyphicon glyphicon-trash\"></span></button>" +
                     "</div>" +
                     "<div class=\"action-progression\">" +
                        "<div class=\"progress\">" +
                           "<div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" style=\"width: 0%\">" +
                              "<span class=\"hidden\">60% Complete</span>" +
                           "</div>" +
                        "</div>" +
                        "<span class=\"message\"></span>" +
                      "</div>" +
                  "</td>" +
              "</tr>";

      $("table#plugin-install-update-list").append(s);
   }

   function getLineFromItem(item) {
      return $("table#plugin-install-update-list").find("tr#" + item.uid);
   }

   function updateLine(item) {
      var $line = getLineFromItem(item);

      //we manage general information
      if (!isNullOrUndefined(item.version)) {
         //we can display the local version
         $line.find("em.local-version").text(versionToString(item));
      }
      else {
         $line.find("em.local-version").text("");
      }

      if (!item.processing) {
         //no action in progress we show action buttons

         $line.find("div.action-buttons").removeClass("hidden");
         $line.find("div.action-progression").addClass("hidden");

         //we manage actions buttons
         var uninstallAllowed = false;
         var installUpdateAllowed = false;
         var canChooseVersion = false;

         var availableVersions = [];
         var latestVersion = undefined;

         if (!isNullOrUndefined(item.serverVersions)) {
            //we create a list of all version available to update based on the type of the version and the list of available version different from the local one
            $.each(item.serverVersions, function (index, value) {
               if ($.inArray(value.releaseType.toLowerCase(), wantedVersion) > -1) {
                  //we manage latest vzersion
                  if (isNullOrUndefined(latestVersion)) {
                     //latestVersion hasn't defined for the moment we take the first one
                     latestVersion = value;
                  }
                  else {
                     //we compare the version with the cumulated to take the latest
                     if (UpdateInformationManager.compareVersion(latestVersion, value) > 0) {
                        latestVersion = value;
                     }
                  }

                  //if this releasetype is wanted we add it to the arrays of version for this item
                  if (!matchVersion(item, value)) {
                     availableVersions.push(value);
                  }
               }
            });
         }

         if (!isNullOrUndefined(item.version)) {
            //the plugin is already installed so the button is used to update
            $line.find("div.btn-install button.main-btn").attr("data-i18n", "[title]modals.dashboard.sub-windows.install-update.generic.install");

            //the component is already installed so we can uninstall it
            uninstallAllowed = true;
         }
         else {
            $line.find("div.btn-install button.main-btn").attr("data-i18n", "[title]modals.dashboard.sub-windows.install-update.generic.update");
         }

         if (availableVersions.length > 0) {
            if (availableVersions.length > 1) {
               //there is different versions visible
               canChooseVersion = true;
            }

            //the main install button is allowed only if latest version and current version are different
            installUpdateAllowed = (UpdateInformationManager.compareVersion(item, latestVersion) != 0);

            //we create a combo that have all available versions for install or update
            $cbVersion = $line.find("ul.versions");
            $cbVersion.empty();
            availableVersions.sort(UpdateInformationManager.compareVersion);

            $.each(availableVersions, function(index, value) {

               $cbVersion.append("<li downloadUrl=\"" + value.downloadUrl + "\"><a href=\"#\"><em>" + versionToString(value) + "</em></a></li>");
               //we manage the click event on each version
               if (!isNullOrUndefined(item.version)) {
                  //the item is already ionstalled, we ask an update
                  $cbVersion.find("li").last().unbind('click').bind('click', askForPluginUpdate(item, value));
               }
               else {
                  //the item isn't installed so we make a new install
                  $cbVersion.find("li").last().unbind('click').bind('click', askForPluginInstall(item, value));
               }
            });

            $line.find("ul.latest-installable-version").text(versionToString(availableVersions[0]));

            //we can display the latest version
            $line.find("em.latest-version").text(versionToString(latestVersion));
         }
         else {
            //there is no interesting new version
            $line.find("button.btn-expand").addClass("disabled");
         }

         if (uninstallAllowed)
            $line.find("button.btn-uninstall").removeClass("disabled");
         else
            $line.find("button.btn-uninstall").addClass("disabled");

         if (installUpdateAllowed) {
            $line.find("div.btn-install button.main-btn").removeClass("disabled");
         }
         else {
            $line.find("div.btn-install button.main-btn").addClass("disabled");
         }

         //if the user can choose version we enable the list
         if (canChooseVersion)
            $line.find("div.btn-install button.btn-expand").removeClass("disabled");
         else
            $line.find("div.btn-install button.btn-expand").addClass("disabled");

         //we manage click events
         if (!isNullOrUndefined(item.version)) {
            //the item is already installed, we ask an update
            $line.find("button.main-btn").unbind('click').bind('click', askForPluginUpdate(item, availableVersions[0]));
            $line.find("button.btn-uninstall").unbind('click').bind('click', askForPluginRemove(item));
         }
         else {
            //the item isn't installed so we make a new install
            $line.find("button.main-btn").unbind('click').bind('click', askForPluginInstall(item, availableVersions[0]));
         }
      }
      else {
         //an action is in progress we show progression
         $line.find("div.action-buttons").addClass("hidden");
         $line.find("div.action-progression").removeClass("hidden");
      }
   }

   function askForPluginInstall(item, updateInformation) {
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmInstallTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmInstall", {
                       objectName: item.name,
                       version: versionToString(updateInformation)
                    }),
                    function () {
                       //the user has confirmed the action
                       var $line = getLineFromItem(item);
                       $line.find("div.progress-bar").css("width", "0%");
                       UpdateInformationManager.installPlugin(updateInformation.downloadUrl, function (taskId) {
                          installUpdateRemovePluginCallback(taskId, item, $line);
                       });
                    });
         });
      }
   }

   function askForPluginUpdate(item, updateInformation) {
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdateTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdate", {
                       objectName: item.name,
                       version: versionToString(updateInformation)
                    }),
                    function () {
                       //the user has confirmed the action
                       var $line = getLineFromItem(item);
                       $line.find("div.progress-bar").css("width", "0%");
                       UpdateInformationManager.updatePlugin(item.name, updateInformation.downloadUrl, function (taskId) {
                          installUpdateRemovePluginCallback(taskId, item, $line);
                       });
                    });
         });
      }
   }

   function askForPluginRemove(item) {
      return function() {
         modals.confirmation.load(function() {
            showConfirmModal(btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmRemoveTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmRemove", {objectName: item.name}),
                    function () {
                       //the user has confirmed the action
                       UpdateInformationManager.removePlugin(item.name, function (taskId) {
                          console.debug("TaskId : " + taskId);
                          //TODO : manage taskId and websocket
                       });
                    });
         });
      }
   }

   function installUpdateRemovePluginCallback(taskId, item, $line) {
      console.debug("TaskId : " + taskId);
      //we listen for websocket event
      $(document).on("taskupdatenotification." + taskId, function (e, taskUpdateInformation) {
         $line.find("div.progress-bar").css("width", taskUpdateInformation.progression + "%");
         $line.find("span.message").text($.t("webSockets." + taskUpdateInformation.message));

         var taskFinished = false;
         //we manage the end of the task
         if (taskUpdateInformation.taskState.toLowerCase() == "fail") {
            console.error("Unable to install plugin : " + taskUpdateInformation.exception);
            notifyError($.t("webSockets." + taskUpdateInformation.message));
            taskFinished = true;
         }

         if (taskUpdateInformation.taskState.toLowerCase() == "success") {
            notifySuccess($.t("webSockets." + taskUpdateInformation.message));
            taskFinished = true;
         }

         if (taskFinished) {
            //we remove the progress information and restore buttons
            item.processing = false;
            updateLine(item);
            $line.find("div.progress-bar").css("width", "0%");
         }

      });
      //we hide the buttons and show the progression
      item.processing = true;
      updateLine(item);
   }

   function matchVersion(version1, version2) {
      return ((version1.version == version2.version) && (version1.releaseType.toLowerCase() == version2.releaseType.toLowerCase()))
   }

   /**
    * Convert the version and the release type to a string
    * @param version
    * @returns {string}
    */
   function versionToString(version) {
      if ((isNullOrUndefined(version.version)) || (isNullOrUndefined(version.releaseType)))
         return "";
      return "v " + version.version + " " + version.releaseType.toLowerCase();
   }

</script>