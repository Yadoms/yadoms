language: cpp

#limit to git depth to 1 because don't use any git command in this script
git:
  depth: 1
  
before_install:

#g++ 4.8
- echo 'Installing G++ 4.8'
- sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
- sudo apt-get update -qq
- if [ "$CXX" = "g++" ]; then sudo apt-get install -qq g++-4.8; fi
- if [ "$CXX" = "g++" ]; then export CXX="g++-4.8" CC="gcc-4.8"; fi
- sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 90

# deps
- echo 'Installing some dependencies'
- sudo apt-get install libbz2-dev python-dev libudev-dev

#CMake
- echo 'Installing CMake 3.4.3'
- sudo apt-get remove cmake

- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && wget  -U 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.6) Gecko/20070802 SeaMonkey/1.1.4' http://yadoms.com/travis_build/cmake-3.4.3-build.tar.bz2 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && wget --no-check-certificate https://cmake.org/files/v3.4/cmake-3.4.3.tar.gz
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && tar jxf cmake-3.4.3-build.tar.bz2
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && tar zxf cmake-3.4.3.tar.gz
- cd cmake-3.4.3 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass bootstrap" 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && ./bootstrap  > yadoms_cmake.log
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass make"
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && make  > yadoms_cmake.log
- sudo make install  > yadoms_cmake.log
- cd ..
- $TRAVIS_UPLOAD_COMPONENTS == "true" && tar cjf cmake-3.4.3-build.tar.bz2 cmake-3.4.3 
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass packaging"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && curl --ftp-create-dirs -T cmake-3.4.3-build.tar.bz2 -u $FTP_USER:$FTP_PASSWORD ftp://ftp.jano42.fr/travis_build/
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass upload"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && rm -f cmake-3.4.3-build.tar.bz2
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass cleanup"

# boost
- echo 'Building Boost 1.62.0'
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && wget -U 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.6) Gecko/20070802 SeaMonkey/1.1.4' http://yadoms.com/travis_build/boost_1_62_0-build.tar.bz2 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && wget http://netcologne.dl.sourceforge.net/project/boost/boost/1.62.0/boost_1_62_0.tar.bz2
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && tar xjf boost_1_62_0-build.tar.bz2 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && tar xjf boost_1_62_0.tar.bz2
- cd boost_1_62_0
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass boost/bootstrap" 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && ./bootstrap.sh > yadoms_boost.log
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass boost/b2" 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && ./b2 --with-atomic --with-chrono --with-date_time --with-filesystem --with-regex --with-thread --with-system link=shared > yadoms_boost.log
- cd ..
- $TRAVIS_UPLOAD_COMPONENTS == "true" && tar cjf boost_1_62_0-build.tar.bz2 boost_1_62_0
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass packaging"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && curl --ftp-create-dirs -T boost_1_62_0-build.tar.bz2 -u $FTP_USER:$FTP_PASSWORD ftp://ftp.jano42.fr/travis_build/ 
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass upload"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && rm -f boost_1_62_0-build.tar.bz2 
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass cleanup"
  
 # poco
- echo 'Building Poco 1.7.6-all'
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && wget -U 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.6) Gecko/20070802 SeaMonkey/1.1.4' http://yadoms.com/travis_build/poco-1.7.6-all-build.tar.bz2 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && wget http://pocoproject.org/releases/poco-1.7.6/poco-1.7.6-all.tar.gz
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && tar xjf poco-1.7.6-all-build.tar.bz2 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && tar xzf poco-1.7.6-all.tar.gz
- sudo apt-get install libssl-dev
- cd poco-1.7.6-all/
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass poco/configure"
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && ./configure --omit=CppUnit,CppUnit/WinTestRunner,Data,Data/SQLite,Data/ODBCData/MySQL,MongoDB,PageCompiler,PageCompiler/File2Page  --no-samples --no-tests > yadoms_poco.log
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass poco/make"
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && make > yadoms_poco.log
- cd ..
- $TRAVIS_UPLOAD_COMPONENTS == "true" && tar cjf poco-1.7.6-all-build.tar.bz2 poco-1.7.6-all
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass packaging"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && curl --ftp-create-dirs -T poco-1.7.6-all-build.tar.bz2 -u $FTP_USER:$FTP_PASSWORD ftp://ftp.jano42.fr/travis_build/ 
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass upload"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && rm -f poco-1.7.6-all-build.tar.bz2 
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass cleanup"

# protobuf
- echo 'Building Protobuf 2.6.1'
- sudo apt-get install autoconf libtool
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && wget -U 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.6) Gecko/20070802 SeaMonkey/1.1.4' http://yadoms.com/travis_build/protobuf-2.6.1-build.tar.bz2 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && wget https://github.com/google/protobuf/releases/download/v2.6.1/protobuf-2.6.1.tar.gz
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && tar xjf protobuf-2.6.1-build.tar.bz2
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && tar xzf protobuf-2.6.1.tar.gz
- cd protobuf-2.6.1
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass protobuf/autogen" 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && ./autogen.sh > yadoms_protobuf.log
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass protobuf/configure" 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && ./configure > yadoms_protobuf.log
- $TRAVIS_USE_UPLOADED_COMPONENTS == "true" && echo "Bypass protobuf/make" 
- $TRAVIS_USE_UPLOADED_COMPONENTS == "false" && make > yadoms_protobuf.log
- sudo make install > yadoms_protobuf.log
- sudo ldconfig
- cd ..
- $TRAVIS_UPLOAD_COMPONENTS == "true" && tar cjf protobuf-2.6.1-build.tar.bz2 protobuf-2.6.1
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass packaging"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && curl --ftp-create-dirs -T protobuf-2.6.1-build.tar.bz2 -u $FTP_USER:$FTP_PASSWORD ftp://ftp.jano42.fr/travis_build/
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass upload"
- $TRAVIS_UPLOAD_COMPONENTS == "true" && rm -f protobuf-2.6.1-build.tar.bz2
- $TRAVIS_UPLOAD_COMPONENTS == "false" && echo "By pass cleanup"

#gammu
- echo 'Building Gammu 1.36.8'
- wget http://dl.cihar.com/gammu/releases/gammu-1.36.8.tar.gz
- tar zxf gammu-1.36.8.tar.gz
- cd gammu-1.36.8
- mkdir build
- cd build
- cmake .. -DBUILD_SHARED_LIBS=ON > yadoms_gammu.log
- make > yadoms_gammu.log
- cd ..
- cd ..


# PCRE
- echo 'Installing PRCE'
- sudo apt-get install libpcre3 libpcre3-dev

# SWIG
- echo 'Building Swig 3.0.8'
- wget http://prdownloads.sourceforge.net/swig/swig-3.0.8.tar.gz
- tar xzf swig-3.0.8.tar.gz
- cd swig-3.0.8
- ./configure > yadoms_swig.log
- make> yadoms_swig.log
- sudo make install > yadoms_swig.log
- cd ..

# PostgreSQL
- sudo apt-get install libpq-dev postgresql-server-dev-9.3

script:
# Yadoms configuration file
- echo 'Configuring Yadoms CMakeListsUserConfig.txt'
- cp sources/CMakeListsUserConfig.sample.txt sources/CMakeListsUserConfig.txt 
- echo 'set(BOOST_ROOT "'$PWD'/boost_1_62_0")' > sources/CMakeListsUserConfig.txt
- echo 'set(POCO_ROOT "'$PWD'/poco-1.7.6-all")' >> sources/CMakeListsUserConfig.txt
- echo 'set(COTIRE_USE ON)' >> sources/CMakeListsUserConfig.txt
- echo 'set(COTIRE_USE_UNITY ON)' >> sources/CMakeListsUserConfig.txt
- echo 'set(PROTOBUF_ROOT "'$PWD'/protobuf-2.6.1")' >> sources/CMakeListsUserConfig.txt
- echo 'set(GAMMU_ROOT "'$PWD'/gammu-1.36.8")' >> sources/CMakeListsUserConfig.txt
- echo 'set(SWIG_ROOT "'$PWD'/swig-3.0.8")' >> sources/CMakeListsUserConfig.txt
- echo 'Result:'
- cat sources/CMakeListsUserConfig.txt

# Yadoms
- echo 'Generating makefile'
- sh cmake_linux.sh m
- cd projects
- echo 'Building Yadoms'
- make all_unity
- cd ..

