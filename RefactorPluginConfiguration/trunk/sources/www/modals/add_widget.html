<link href="../css/add_widget.css" rel="stylesheet">

<!--New widget Modal -->
<div class="modal fade" id="new-widget-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Add a new Widget</h4>
            </div>
            <div class="modal-body">
                <div id="new-widget-carousel" class="carousel slide">

                    <!-- Wrapper for slides -->
                    <div class="carousel-inner">
                        <!-- widgets types will be inserted here -->
                    </div>

                    <!-- Controls -->
                    <a class="left carousel-control" href="#new-widget-carousel" data-slide="prev">
                        <span class="icon-prev"></span>
                    </a>
                    <a class="right carousel-control" href="#new-widget-carousel" data-slide="next">
                        <span class="icon-next"></span>
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-get-more-widget" type="button" class="btn btn-primary pull-left">Get more widget</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button id="btn-confirm-add-widget" type="button" class="btn btn-primary">Add new</button>
            </div>
        </div>
    </div>
</div>

<script>
    //we indicate that add_widget.html has been loaded
    addWidgetHasBeenLoaded = true;

    /**
     * Ask for widget packages to the REST server
     */
    function askWidgetPackages()
    {
       $.getJSON("rest/widget/packages")
               .done(requestWidgetsTypeDone())
               .fail(function() {notifyError("Unable to get widget packages")});
    }

    /**
     * Callback of the request widget packages
     * @returns {Function}
     */
    function requestWidgetsTypeDone()
    {
       return function( data ) {
          //we parse the json answer
          if (data.result != "true")
          {
             notifyError("Error during requesting widget packages");
             return;
          }
          $("div#new-widget-carousel > div.carousel-inner > div").remove();
          //noinspection JSUnusedLocalSymbols
          $.each(data.data.packages, function(index, value) {
             //foreach widget-type
             //carousel item creation
             $("div#new-widget-carousel > div.carousel-inner").append(
                     "<div class=\"item\" package=\"" + value.name + "\" >" +
                             "<img class=\"carousel-widget-preview\" src=\"/widgets/" + value.name + "/preview.png\">" +
                             "<div class=\"carousel-caption\">" + value.description + "</div>" +
                             "</div>"
             );
          });

          //we activate first item of carousel
          $("div#new-widget-carousel div.item").first().addClass("active");

          $('div.carousel').carousel('pause');

          //we display the modal
          $('div#new-widget-modal').modal();
       };
    }

    /**
     * Callback to the click of the button to confirm an add of a new widget
     */
    $("button#btn-confirm-add-widget").click(function () {

       var currentPage = getCurrentPage();
       assert(currentPage != null, "A page must be selected");

        //we close the new widget modal
        $("div#new-widget-modal").modal("hide");

        var packageName = $('div#new-widget-carousel div.active').attr("package");
        
        $.ajax({
            type: "POST",
            url: "/rest/widget",
            data: JSON.stringify({ idPage: currentPage.id, name: packageName, sizeX: "1", sizeY:"1", positionX:"1", positionY:"1" }),
            contentType: "application/json; charset=utf-8",
            dataType: "json"
        })
        .done(function(data) {
            //we parse the json answer
            if (data.result != "true")
            {
               notifyError("Error during creating widget");
               return;
            }
            notifySuccess("Widget successfully created");
            //we add the widget dynamically
            var w = new Widget(data.data.id, data.data.idPage, data.data.name, data.data.sizeX, data.data.sizeY, data.data.positionX, data.data.positionY, data.data.configuration);
            addWidgetToIHM(w);
        })
        .fail(function(widgetName) { return function() {notifyError("Unable to create widget of type " + widgetName)}}(packageName));
    });

</script>