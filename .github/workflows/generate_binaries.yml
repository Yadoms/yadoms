name: Binaries generation

on: push

jobs:
  linux:
    name : Generate for Linux
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Yadoms build script
      uses: Yadoms/build-yadoms-action@v3.beta5
      id: yadoms_build_step
      with:
          buildImage: docker.pkg.github.com/yadoms/docker/build_for_linux:latest
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          entrypoint: '/entrypoint_docker.sh'
    - name: Get tag/branch name
      id: vars
      run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}
    - name: Create Release (on Tag only)
      id: create_release
      uses: ncipollo/release-action@v1
      if: contains(github.ref, 'refs/tags/')
      with:
        tag: ${{ github.ref }}
        name: ${{ steps.vars.outputs.tag }}
        draft: true
        prerelease: true
        allowUpdates: true
        omitNameDuringUpdate: true
        replacesArtifacts: true
        artifacts: "./builds/package/*"
        token: ${{ secrets.GITHUB_TOKEN }}
    
  MacOSX:
    name : Generate for MacOSX
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Yadoms build script
      uses: Yadoms/build-yadoms-action@v3.beta5
      id: yadoms_build_step
      with:
          buildImage: docker.pkg.github.com/yadoms/docker/build_for_macos:latest
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          entrypoint: '/entrypoint_docker.sh'
    - name: Get tag/branch name
      id: vars
      run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}
    - name: Create Release (on Tag only)
      id: create_release
      uses: ncipollo/release-action@v1
      if: contains(github.ref, 'refs/tags/')
      with:
        tag: ${{ github.ref }}
        name: ${{ steps.vars.outputs.tag }}
        draft: true
        prerelease: true
        allowUpdates: true
        omitNameDuringUpdate: true
        replacesArtifacts: true
        artifacts: "./builds/package/*"
        token: ${{ secrets.GITHUB_TOKEN }}
        
  Synology218p:
    name : Generate for Synology 218+
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Yadoms build script
      uses: Yadoms/build-yadoms-action@v3.beta5
      id: yadoms_build_step
      with:
          buildImage: docker.pkg.github.com/yadoms/docker/build_for_synology218p:latest
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          entrypoint: '/entrypoint_docker.sh'
    - name: Get tag/branch name
      id: vars
      run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}
    - name: Create Release (on Tag only)
      id: create_release
      uses: ncipollo/release-action@v1
      if: contains(github.ref, 'refs/tags/')
      with:
        tag: ${{ github.ref }}
        name: ${{ steps.vars.outputs.tag }}
        draft: true
        prerelease: true
        allowUpdates: true
        omitNameDuringUpdate: true
        replacesArtifacts: true
        artifacts: "./builds/package/*"
        token: ${{ secrets.GITHUB_TOKEN }}     

  RapsberryPI:
    name : Generate for RaspberryPI (all versions)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Yadoms build script
      uses: Yadoms/build-yadoms-action@v3.beta5
      id: yadoms_build_step
      with:
          buildImage: docker.pkg.github.com/yadoms/docker/build_for_raspberrypi:latest
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          privileged: '--privileged'
          entrypoint: '/entrypoint_docker.sh'
    - name: Get tag/branch name
      id: vars
      run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}
    - name: Create Release (on Tag only)
      id: create_release
      uses: ncipollo/release-action@v1
      if: contains(github.ref, 'refs/tags/')
      with:
        tag: ${{ github.ref }}
        name: ${{ steps.vars.outputs.tag }}
        draft: true
        prerelease: true
        allowUpdates: true
        omitNameDuringUpdate: true
        replacesArtifacts: true
        artifacts: "./builds/package/*"
        token: ${{ secrets.GITHUB_TOKEN }}     
        
  Windows:
    name : Generate for Windows
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Yadoms build script
      uses: Yadoms/build-yadoms-windows-action@v1.beta1
      id: yadoms_build_step
      with:
          buildImage: yadoms/build_for_windows:latest
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_OAUTH }}
          entrypoint: 'powershell.exe -Command C:\work\build-scripts\windows\entrypoint_docker.ps1'
    - name: Get tag/branch name
      id: vars
      run: Write-Host "::set-output name=tag::$( $env:GITHUB_REF -replace '^refs/.*/(.*)$','$1')"
      shell: powershell
    - name: Create Release (on Tag only)
      id: create_release
      uses: ncipollo/release-action@v1
      if: contains(github.ref, 'refs/tags/')
      with:
        tag: ${{ github.ref }}
        name: ${{ steps.vars.outputs.tag }}
        draft: true
        prerelease: true
        allowUpdates: true
        omitNameDuringUpdate: true
        replacesArtifacts: true
        artifacts: "./builds/package/*"
        token: ${{ secrets.GITHUB_TOKEN }}     
                
