<div id="dashboard-install-update">
    <h1 class="page-header">
        <span class="glyphicon glyphicon-save"></span>&nbsp;
        <span data-i18n="modals.dashboard.sub-windows.install-update.title"></span>
        <i class="making-async-action pull-right fa fa-circle-o-notch fa-spin hidden"></i>
    </h1>
    <div class="checkbox">
        <label>
            <input type="checkbox" class="cb-release-type">&nbsp;&nbsp;
            <span data-i18n="modals.dashboard.sub-windows.install-update.includePreRelease">Include pre-release versions</span>
        </label>
    </div>

    <h2 id="install-update-developerModeWarning" class="bg-danger hidden">
        <span data-i18n="modals.dashboard.sub-windows.install-update.developerModeWarning"></span>
    </h2>

    <div class="panel-group" id="install-update-accordion" role="tablist" aria-multiselectable="true">
        <!--accordion yadoms update-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading" role="tab" id="install-update-yadoms-heading-panel" data-toggle="collapse" data-parent="#install-update-accordion"
                aria-expanded="true" aria-controls="install-update-yadoms-heading-panel" data-target="#install-update-yadoms-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-yadoms-panel" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="install-update-yadoms-heading-panel">
                <div class="panel-body">
                    <table id="yadoms-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <tr class="yadoms-information">
                            <td>
                                <span>Yadoms</span>
                                <span class="update-available-label hidden label label-as-badge label-success">!</span>
                            </td>
                            <td>
                                <img src="/img/icon_256.png" class="img-thumbnail dashboard-table-icon">
                            </td>
                            <td>
                                <em class="local-version"></em>
                            </td>
                            <td>
                                <em class="latest-version"></em>
                            </td>
                            <td>
                                <div class="action-buttons btn-group">
                                    <div class="btn-group btn-install">
                                        <button type="button" class="btn main-btn btn-primary disabled" data-i18n="[title]modals.dashboard.sub-windows.install-update.generic.update">
                                            <span class="glyphicon glyphicon-save "></span>
                                            <span class="latest-installable-version"></span>
                                        </button>
                                        <button type="button" class="btn dropdown-toggle btn-expand btn-primary disabled" data-toggle="dropdown" aria-expanded="false">
                                            <span class="caret"></span>
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <ul class="dropdown-menu versions" role="menu">
                                            <!--available versions of yadoms here-->
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-info btn-changelog disabled" data-i18n="[title]modals.dashboard.sub-windows.install-update.generic.changelog">
                                        <span class="fa fa-file-text-o"></span>
                                    </button>
                                </div>
                                <div class="action-progression hidden">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0">
                                            <span class="hidden">60% Complete</span>
                                        </div>
                                    </div>
                                    <span class="message"></span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <!--accordion plugin-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading collapsed" role="tab" id="install-update-plugin-heading-panel" data-toggle="collapse" data-parent="#install-update-accordion"
                aria-expanded="true" aria-controls="install-update-plugin-heading-panel" data-target="#install-update-plugin-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.plugins.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-plugin-panel" class="panel-collapse collapse" role="tabpanel" aria-labelledby="install-update-plugin-heading-panel">
                <div class="panel-body">
                    <table id="plugin-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <!-- plugins will be listed here-->
                    </table>
                </div>
            </div>
        </div>
        <!--accordion widget-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading collapsed" role="tab" id="install-update-widget-heading-panel" data-toggle="collapse" data-parent="#install-update-accordion"
                aria-expanded="true" aria-controls="install-update-widget-heading-panel" data-target="#install-update-widget-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.widgets.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-widget-panel" class="panel-collapse collapse" role="tabpanel" aria-labelledby="install-update-widget-heading-panel">
                <div class="panel-body">
                    <table id="widget-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <!-- widgets will be listed here-->
                    </table>
                </div>
            </div>
        </div>
        <!--accordion script interpreters-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading collapsed" role="tab" id="install-update-scriptInterpreter-heading-panel" data-toggle="collapse"
                data-parent="#install-update-accordion" aria-expanded="true" aria-controls="install-update-scriptInterpreter-heading-panel"
                data-target="#install-update-scriptInterpreter-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.scriptInterpreters.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-scriptInterpreter-panel" class="panel-collapse collapse" role="tabpanel" aria-labelledby="install-update-scriptInterpreter-heading-panel">
                <div class="panel-body">
                    <table id="scriptInterpreter-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <!-- script interpreters will be listed here-->
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="hidden" id="yadoms-updating-splash">
    <h1 class="updating">
        <span class="glyphicon glyphicon-save" aria-hidden="true"></span>
        <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.updating"></span>
    </h1>
    <h1 class="restarting hidden">
        <span class="glyphicon glyphicon-hourglass" aria-hidden="true"></span>
        <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.restarting"></span>
    </h1>
    <div class="progress progress-striped active">
        <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
        </div>
    </div>
</div>

<script>
    var $cbIncludePreReleases = $("div#dashboard-install-update input.cb-release-type")
    var includePreReleases = false;

    Yadoms.initializeInstallUpdateDashboard = function () {
       var arrayOfDeffered = [];
       var d = new $.Deferred();
       
       arrayOfDeffered.push(asyncLoadJSGzLibs([
           "libs/markdown-it/markdown-it.min.js.gz",
           "libs/markdown-it/markdown-it-for-inline.min.js.gz"]));       
       
       arrayOfDeffered.push(asyncLoadJSLibs([
          "js/objects/update/update-information.js",
          "js/objects/update/update-information-manager.js",
          "js/objects/update/yadoms-update-information-manager.js"
       ]));
       
       $.when.apply($, arrayOfDeffered).done(function () {
          scanForUpdates().done(function(){
             d.resolve();
          });
       })
       .fail(function () {
          d.reject();
       });
       return d.promise();          
    };

    YadomsInformationManager.getList()
        .done(function (data) {
            if (data.developerMode) {
                $("#install-update-developerModeWarning").removeClass("hidden");
            } else {
                $("#install-update-developerModeWarning").addClass("hidden");
            }
        })

    /**
     * Permit to update includePreReleases from the checkbox
     */
    function updateReleaseType() {
        includePreReleases = $cbIncludePreReleases.prop("checked");
    }

    function scanForUpdates() {
        var d = new $.Deferred();
        $cbIncludePreReleases.unbind();
        var $asyncActionIndicator = $("div#dashboard-install-update i.making-async-action");
        $asyncActionIndicator.removeClass("hidden");

        UpdateInformationManager.scanForUpdates()
            .done(function (data) {
                //we listen for webSocket event
                $(document).on("taskupdatenotification." + data.taskId, function (e, taskUpdateInformation) {
                    var taskFinished = false;
                    //we manage the end of the task
                    if (taskUpdateInformation.taskState.toLowerCase() === "fail") {
                        notifyError($.t("modals.dashboard.sub-windows.install-update.failTtoGetUpdates"));
                        taskFinished = true;
                    } else if (taskUpdateInformation.taskState.toLowerCase() === "success") {
                        taskFinished = true;
                    }

                    if (taskFinished) {
                        $asyncActionIndicator.addClass("hidden");
                        $cbIncludePreReleases.change(refreshAllData);
                        refreshAllData();
                    }
                });
                d.resolve();
            })

            .fail(function (error) {
                notifyError($.t("modals.dashboard.sub-windows.install-update.failTtoGetUpdates"));
                $asyncActionIndicator.addClass("hidden");
                d.reject();
            });
        return d;
    }

    /**
     * Ask a refresh of all data in the modal
     */
    function refreshAllData() {
        var d = new $.Deferred();

        updateReleaseType();

        //we remove update available header
        $(".panel-title span.update-available-label").addClass("hidden");

        UpdateInformationManager.getList(includePreReleases)
            .done(function (data) {
                if (data.yadoms) {
                    buildYadomsLine(data.yadoms);
                }
                if (data.plugins)
                    // Load plugins translations
                    PluginManager.getAll().always(function() {
                        buildList("plugin", data.plugins)
                    });
                if (data.widgets) {
                    // Load widgets translations
                    var arrayOfDeffered = [];           
                    $.each(_.keys(WidgetPackageManager.packageList), function(index, Package) {
                        arrayOfDeffered.push(WidgetPackageManager.loadLanguage(Package)); // load the language package if any
                    });               
                    $.when.apply($, arrayOfDeffered).always(function() {
                        buildList("widget", data.widgets)
                    });
                }
                if (data.scriptInterpreters)
                    // Load script interpreters translations
                    AutomationInterpreterManager.getAllDetailed().always(function () {
                        buildList("scriptInterpreter", data.scriptInterpreters);
                    });
                d.resolve();
            })
            .fail(d.reject)

        return d.promise();
    }

    /**
     * Build the Yadoms line
     */
    function buildYadomsLine(item) {
        // Construction is done directly in HTML

        // Update the line
        updateYadomsLine(item);
    }

    /**
     * Update the Yadoms line
     */
    function updateYadomsLine(item) {
        assert(!isNullOrUndefined(item), "item must be defined");

        var $line = $("table#yadoms-install-update-list tr.yadoms-information");

        // Local version
        $line.find("em.local-version").text(isNullOrUndefined(item.versions.installed) ? "" : item.versions.installed);

        // Newest version
        var newestVersionLabel = (isNullOrUndefined(item.versions.newest) || $.isEmptyObject(item.versions.newest)) ?
            "" : Object.keys(item.versions.newest)[0];
        $line.find("em.latest-version").text(newestVersionLabel);
        $line.find("span.latest-installable-version").text(newestVersionLabel);

        // Create a combo
        var $cbVersion = $line.find("ul.versions");
        createVersionsCombo($cbVersion, item,
            function (versionLabel, downloadUrl) {
                askForYadomsUpdate(versionLabel, downloadUrl, item);
            });

        // Show buttons or progressbar
        if (item.processing) {
            $line.find("div.action-progression").removeClass("hidden");
            $line.find("div.action-buttons").addClass("hidden");
        } else {
            $line.find("div.action-progression").addClass("hidden");
            $line.find("div.action-buttons").removeClass("hidden");

            // Main install/update button
            var $mainInstallButton = $line.find("div.btn-install button.main-btn");
            if (newestVersionLabel && !isNullOrUndefinedOrEmpty(item.versions.installed)) {
                $mainInstallButton.removeClass("disabled");
                $mainInstallButton.unbind('click').bind('click', function () {
                    askForYadomsUpdate(newestVersionLabel, Object.values(item.versions.newest)[0].downloadUrl,
                        item);
                });
            } else {
                $mainInstallButton.addClass("disabled");
                $mainInstallButton.unbind('click');
            }

            // Dropdown button for other versions than newest
            if ($cbVersion.find("li").length)
                $line.find("div.btn-install button.btn-expand").removeClass("disabled");
            else
                $line.find("div.btn-install button.btn-expand").addClass("disabled");

            // Show changelog button
            var $showChangelogButton = $line.find("div.action-buttons button.btn-changelog");
            if (!isNullOrUndefinedOrEmpty(item.changelogUrl)) {
                $showChangelogButton.removeClass("disabled");
                $showChangelogButton.unbind('click').bind('click', function () {
                    showChangelog(item.changelogUrl);
                });
            } else {
                $showChangelogButton.addClass("disabled");
                $showChangelogButton.unbind('click');
            }

            // Show new version indicator
            if (newestVersionLabel && !isNullOrUndefinedOrEmpty(item.versions.installed)) {
                $line.find("span.update-available-label").removeClass("hidden");
            } else {
                $line.find("span.update-available-label").addClass("hidden");
            }

            updateHeaderUpdateAvailableLabel("yadoms");
        }
    }

    function askForYadomsUpdate(version, downloadUrl, item) {
        assert(!isNullOrUndefined(version), "version must be defined");
        assert(!isNullOrUndefined(downloadUrl), "downloadUrl must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdateTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdate", {
                        objectName: $.t("core.yadoms.name"),
                        version: version
                    }),
                    function () {
                        //the user has confirmed the action
                        YadomsUpdateInformationManager.update(downloadUrl)
                            .done(function (data) {
                                yadomsUpdateCallback(data.taskId, item);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorUpdating", {
                                    objectName: "yadoms"
                                }), error);
                            });
                    });
            });
    }

    function yadomsUpdateCallback(taskId, item) {
        assert(!isNullOrUndefined(taskId), "taskId must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        //we initialize the progress bar
        var $line = $("table#yadoms-install-update-list tr.yadoms-information");
        var progressBar = $line.find("div.progress-bar");
        progressBar.css("width", "0");

        //we listen for webSocket event
        $(document).on("taskupdatenotification." + taskId, function (e, taskUpdateInformation) {
            progressBar.css("width", taskUpdateInformation.progression + "%");
            $line.find("span.message").text($.t("core." + taskUpdateInformation.message));

            //we manage the end of the task
            if (taskUpdateInformation.taskState.toLowerCase() === "fail") {
                console.error("Unable to update Yadoms : " + taskUpdateInformation.exception);
                notifyError($.t("core." + taskUpdateInformation.message));

                //we remove the progress information and restore buttons
                item.processing = false;
                scanForUpdates();
            } else if (taskUpdateInformation.taskState.toLowerCase() === "success") {
                notifySuccess($.t("core." + taskUpdateInformation.message));
                //we display a non closable modal and wait for yadoms restart
                waitForUpdateFinished();
            }
        });

        //we hide the buttons and show the progression
        item.processing = true;
        updateYadomsLine(item);
    }

    function waitForUpdateFinished() {
        //we don't want ESC close the modal
        var $splash = $('div#yadoms-updating-splash');
        $splash.i18n();
        $splash.removeClass("hidden");

        stopPeriodicTask();

        //we wait the Server stop to answer request
        waitForYadomsExit();
    }

    function waitForYadomsExit() {
        console.log("Wait Yadoms exiting...");
        var timeout = setTimeout(function () {
            //the timeout has expired. So server is not alive anymore
            waitForYadomsReturn();
        }, 5000);

        //We can consider that the server has exit if it doesn't answer "pong" to the websocket "ping"
        $(document).on("isAlive", function () {
            //we have received a alive answer
            //we resend a new isAlive call until it doesn't answer
            console.log("Yadoms still alive, wait more...");
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                //the timeout has expired. So server is not alive anymore
                console.log("Timeout, Yadoms exited");
                waitForYadomsReturn();
            }, 5000);
            //we send the ping and wait for the answer
            WebSocketEngine.sendIsServerAlive();
        });

        //we send the ping and wait for the answer
        WebSocketEngine.sendIsServerAlive();
    }

    function waitForYadomsReturn() {
        console.log("Wait Yadoms exiting...");
        var $splash = $('div#yadoms-updating-splash');
        $splash.find("h1.updating").addClass("hidden");
        $splash.find("h1.restarting").removeClass("hidden");

        //we try to get information from server loop until the server answer
        EventLoggerManager.getLast({
                timeout: 2000
            })
            .done(function () {
                //we received an answer, the server is back
                //we reload full page (clearing cache)
                console.log("Yadoms is back, reload page (discarding cache)...");
                location.reload(true);
            })
            .fail(function (error) {
                console.log("Yadoms is not back, wait more... (" + error + ")");
                setTimeout(waitForYadomsReturn(), 1000);
            });
    }

    /**
     * Create the list from the localList
     */
    function buildList(objectType, list) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(list), "list must be defined");

        //we remove all rows except header
        var $table = $("table#" + objectType + "-install-update-list");
        $table.find("tr:gt(0)").remove();

        // Add updateable and new items in the same list
        addItemsInTable($table, objectType, list.updateable, function (moduleType, data) {
            console.log(objectType + "s." + moduleType);
            return objectType + "s." + moduleType;
        });


        // For new items, we need to import translations
        var deferredArray = [];
        $.each(list.new, function (moduleType, data) {
            var newestVersion = Object.keys(data.versions.newest)[0];
            deferredArray.push(i18nManager.loadNamespaceFromExternal(getBaseUrl(data.versions.newest[
                    newestVersion].downloadUrl) +
                "/" + moduleType + "/" + newestVersion, moduleType));
        });

        $.when.apply($, deferredArray)
            .done(function () {
                addItemsInTable($table, objectType, list.new, function (moduleType, data) {
                    return moduleType;
                });
            })
            .fail(function () {
                console.error("Fail to load translations for some new plugins");
            });
    }

    function getBaseUrl(fullUrl) {
        var baseUrl = fullUrl;
        baseUrl = baseUrl.slice(0, baseUrl.lastIndexOf('/')); // Remove .zip file
        baseUrl = baseUrl.slice(0, baseUrl.lastIndexOf('/')); // Remove version
        baseUrl = baseUrl.slice(0, baseUrl.lastIndexOf('/')); // remove module type
        return baseUrl;
    }

    function addItemsInTable(inTable, objectType, fromList, getI18nBasePathFct) {
        assert(!isNullOrUndefined(inTable), "inTable must be defined");
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(fromList), "fromList must be defined");
        assert($.isFunction(getI18nBasePathFct), "getI18nBasePathFct must be defined");

        $.each(fromList, function (itemType, data) {
            var lineContent = createInstallUpdateItemLine(objectType, itemType, getI18nBasePathFct(itemType,
                data));

            insertIntoTableInAlphabeticOrder(inTable, lineContent, function (lineContent) {
                return $(lineContent).find("span#name").text();
            });

            updateLine(objectType, itemType, data);
        });
    }

    /**
     * Insert the lineContent into a table, respecting alphabetical order
     */
    function insertIntoTableInAlphabeticOrder(table, lineContent, refTextInLineContentGetter) {
        var rows = table.find("tr");
        var rowsLength = rows.length;

        if (rowsLength == 1) {
            table.append(lineContent);
        } else {
            var $found;
            var newName = refTextInLineContentGetter(lineContent);
            // Ignore first line (header)
            for (var i = 1; i < rowsLength; i++) {
                var rowName = refTextInLineContentGetter(rows[i]);
                if (newName.toLowerCase().localeCompare(rowName.toLowerCase()) < 0) {
                    $found = $(rows[i]);
                    break;
                }
            }
            if (isNullOrUndefined($found))
                table.append(lineContent);
            else
                $found.before(lineContent);
        }
    }

    function createInstallUpdateItemLine(objectType, itemType, i18nBasePath) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");

        var s = "<tr id=\"" + itemType + "\">" +
            "<td><span id=\"name\">" + $.t(i18nBasePath + ":name", {
                defaultValue: itemType
            }) + "</span>" +
            "<span class=\"update-available-label hidden label label-as-badge label-success\">!</span>" +
            "</td>";

        s += "<td><img class=\"img-thumbnail dashboard-table-icon\"></td>";

        s += "<td><span id=\"description\">" + $.t(i18nBasePath + ":description") + "</span></td>";

        s += "<td><em class=\"local-version\"></em></td>";

        s += "<td><em class=\"latest-version\"></em></td>";

        s += "<td>";
        s += "<div class=\"action-buttons btn-group\">" +
            "<div class=\"btn-group btn-install\">" +
            "<button type=\"button\" class=\"btn main-btn btn-primary disabled\">" +
            "<span class=\"glyphicon glyphicon-save \"></span>" +
            "<span class=\"latest-installable-version\"></span>" +
            "</button>" +
            "<button type=\"button\" class=\"btn dropdown-toggle btn-expand btn-primary disabled\" data-toggle=\"dropdown\" aria-expanded=\"false\">" +
            "<span class= \"caret\"></span>" +
            "<span class=\"sr-only\">Toggle Dropdown</span>" +
            "</button>" +
            "<ul class=\"dropdown-menu versions\" role=\"menu\">" +
            "</ul>" +
            "</div>" +
            "<button type=\"button\" class=\"btn btn-info btn-changelog disabled\" data-i18n=\"[title]modals.dashboard.sub-windows.install-update.generic.changelog\"><span class=\"fa fa-file-text-o\"></span></button>" +
            "<button type=\"button\" class=\"btn btn-danger btn-uninstall disabled\" data-i18n=\"[title]modals.dashboard.sub-windows.install-update.generic.uninstall\"><span class=\"fa fa-trash\"></span></button>" +
            "</div>";

        s += "<div class=\"action-progression hidden\">" +
            "<div class=\"progress\">" +
            "<div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" style=\"width: 0%\">" +
            "<span class=\"hidden\">60% Complete</span>" +
            "</div>" +
            "</div>" +
            "<span class=\"message\"></span>" +
            "</div>" +
            "</td>" +
            "</tr>";

        return s;
    }

    /**
     * Get the row the DOM form the item type
     */
    function getLineFromItem(objectType, itemType) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        return $("table#" + objectType + "-install-update-list").find("tr#" + itemType);
    }

    /**
     * Update the label that indicate if in the whole section (plugin, widget, ...) there is at least one item that have an update available
     */
    function updateHeaderUpdateAvailableLabel(objectType) {
        var $line = $("div#install-update-" + objectType + "-heading-panel .update-available-label");
        var $updateAvailableLabels = $("table#" + objectType + "-install-update-list span.update-available-label").not(
            ".hidden");
        if ($updateAvailableLabels.length > 0) {
            //there is at least one item that have an update available
            $line.removeClass("hidden");
            $line.text($updateAvailableLabels.length);
        } else {
            $line.addClass("hidden");
        }
    }

    /**
     * Update the DOM row form the object
     */
    function updateLine(objectType, itemType, item) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        var $line = getLineFromItem(objectType, itemType);

        var $icon = $line.find("img.dashboard-table-icon");
        $icon.attr("a", item.iconUrl);
        $icon.attr("src", item.iconUrl);

        $line.find("em.local-version").text(isNullOrUndefined(item.versions.installed) ? "" : item.versions.installed);

        var newestVersionLabel = (isNullOrUndefined(item.versions.newest) || $.isEmptyObject(item.versions.newest)) ?
            "" : Object.keys(item.versions.newest)[0];
        $line.find("em.latest-version").text(newestVersionLabel);
        $line.find("span.latest-installable-version").text(newestVersionLabel);

        // Create a combo
        var $cbVersion = $line.find("ul.versions");
        createVersionsCombo($cbVersion, item,
            function (versionLabel, downloadUrl) {
                askForUpdate(objectType, itemType, item, objectType + "s/" + itemType, versionLabel, downloadUrl);
            },
            function (versionLabel, downloadUrl) {
                askForInstall(objectType, itemType, item, itemType + "/" + versionLabel, versionLabel,
                    downloadUrl);
            });

        // Show buttons or progressbar
        if (item.processing) {
            $line.find("div.action-progression").removeClass("hidden");
            $line.find("div.action-buttons").addClass("hidden");
        } else {
            $line.find("div.action-progression").addClass("hidden");
            $line.find("div.action-buttons").removeClass("hidden");

            // Main install/update button
            var $mainInstallButton = $line.find("div.btn-install button.main-btn");
            if (newestVersionLabel) {
                $mainInstallButton.removeClass("disabled");
                if (!isNullOrUndefinedOrEmpty(item.versions.installed)) {
                    //the item is already installed, we ask an update
                    $mainInstallButton.unbind('click').bind('click', function () {
                        askForUpdate(objectType, itemType, item, objectType + "s/" + itemType,
                            newestVersionLabel, Object.values(item.versions.newest)[0].downloadUrl);
                    });
                } else {
                    //the item isn't installed so we make a new install
                    $mainInstallButton.unbind('click').bind('click', function () {
                        askForInstall(objectType, itemType, item, itemType + "/" + newestVersionLabel,
                            newestVersionLabel, Object.values(item.versions.newest)[0].downloadUrl);
                    });
                }
            } else {
                $mainInstallButton.addClass("disabled");
                $mainInstallButton.unbind('click');
            }

            // Dropdown button for other versions than newest
            if ($cbVersion.find("li").length)
                $line.find("div.btn-install button.btn-expand").removeClass("disabled");
            else
                $line.find("div.btn-install button.btn-expand").addClass("disabled");

            // Show changelog button
            var $showChangelogButton = $line.find("div.action-buttons button.btn-changelog");
            if (!isNullOrUndefinedOrEmpty(item.changelogUrl)) {
                $showChangelogButton.removeClass("disabled");
                $showChangelogButton.unbind('click').bind('click', function () {
                    showChangelog(item.changelogUrl);
                });
            } else {
                $showChangelogButton.addClass("disabled");
                $showChangelogButton.unbind('click');
            }

            // Uninstall button
            var $uninstallButton = $line.find("div.action-buttons button.btn-uninstall");
            if (item.versions.installed) {
                $uninstallButton.removeClass("disabled");
                $uninstallButton.unbind('click').bind('click', function () {
                    askForRemove(objectType, itemType, item, objectType + "s/" + itemType);
                });
            } else {
                $uninstallButton.addClass("disabled");
                $uninstallButton.unbind('click');
            }

            // Show new version indicator (if module already installed)
            if (newestVersionLabel && !isNullOrUndefinedOrEmpty(item.versions.installed)) {
                $line.find("span.update-available-label").removeClass("hidden");
            } else {
                $line.find("span.update-available-label").addClass("hidden");
            }

            updateHeaderUpdateAvailableLabel(objectType);

        }
    }

    function createVersionsCombo(domElement, item, askForUpdateFct, askForInstallFct) {
        assert(!isNullOrUndefined(domElement), "domElement must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        domElement.empty();

        if (!isNullOrUndefined(item.versions.installed)) {
            // Updatable item

            if (!$.isFunction(askForUpdateFct))
                return;

            // Add newer versions in combo
            if (!isNullOrUndefined(item.versions.newer) && !$.isEmptyObject(item.versions.newer)) {
                $.each(item.versions.newer, function (versionLabel, value) {
                    domElement.append("<li downloadUrl=\"" + value.downloadUrl + "\"><a href=\"#\"><em>" +
                        versionLabel +
                        "</em></a></li>");
                    //we manage the click event on each version
                    domElement.find("li").last().unbind('click').bind('click', function () {
                        askForUpdateFct(versionLabel, value.downloadUrl);
                    });
                });
            }

            // Add older versions in combo
            if (!isNullOrUndefined(item.versions.older) && !$.isEmptyObject(item.versions.older)) {
                $.each(item.versions.older, function (versionLabel, value) {
                    domElement.append("<li downloadUrl=\"" + value.downloadUrl +
                        "\"><a href=\"#\"><em class='text-muted small'>" + versionLabel +
                        "</em></a></li>");
                    //we manage the click event on each version
                    domElement.find("li").last().unbind('click').bind('click', function () {
                        askForUpdateFct(versionLabel, value.downloadUrl);
                    });
                });
            }
        } else {
            // Installable item

            if (!$.isFunction(askForInstallFct))
                return;

            // Add versions in combo
            if (!isNullOrUndefined(item.versions.versions) && !$.isEmptyObject(item.versions.versions)) {
                $.each(item.versions.versions, function (versionLabel, value) {
                    domElement.append("<li downloadUrl=\"" + value.downloadUrl + "\"><a href=\"#\"><em>" +
                        versionLabel +
                        "</em></a></li>");
                    //we manage the click event on each version
                    domElement.find("li").last().unbind('click').bind('click', function () {
                        askForInstallFct(versionLabel, value.downloadUrl);
                    });
                });
            }
        }
    }

    /**
     * Ask for a confirmation of a install of an item
     */
    function askForInstall(objectType, itemType, item, i18nBasePath, version, downloadUrl) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");
        assert(!isNullOrUndefined(version), "version must be defined");
        assert(!isNullOrUndefined(downloadUrl), "downloadUrl must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmInstallTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmInstall", {
                        objectName: $.t(i18nBasePath + ":name", {
                            defaultValue: itemType
                        }),
                        version: version
                    }),
                    function () {
                        //the user has confirmed the action
                        UpdateInformationManager.install(objectType, downloadUrl)
                            .done(function (data) {
                                installUpdateRemoveCallback(objectType, itemType, item, data.taskId);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorInstalling", {
                                    objectName: objectType
                                }), error);
                            });
                    });
            });
    }

    /**
     * Ask for a confirmation of an update of an item
     */
    function askForUpdate(objectType, itemType, item, i18nBasePath, version, downloadUrl) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");
        assert(!isNullOrUndefined(version), "version must be defined");
        assert(!isNullOrUndefined(downloadUrl), "downloadUrl must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdateTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdate", {
                        objectName: $.t(i18nBasePath + ":name", {
                            defaultValue: itemType
                        }),
                        version: version
                    }),
                    function () {
                        //the user has confirmed the action
                        UpdateInformationManager.update(objectType, itemType, downloadUrl)
                            .done(function (data) {
                                installUpdateRemoveCallback(objectType, itemType, item, data.taskId);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorUpdating", {
                                    objectName: objectType
                                }), error);
                            });
                    });
            });
    }

    /**
     * Ask for a confirmation of a remove of an item
     */
    function askForRemove(objectType, itemType, item, i18nBasePath) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmRemoveTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmRemove", {
                        objectName: $.t(i18nBasePath + ":name", {
                            defaultValue: itemType
                        }),
                    }),
                    function () {
                        //the user has confirmed the action
                        UpdateInformationManager.remove(objectType, itemType)
                            .done(function (data) {
                                installUpdateRemoveCallback(objectType, itemType, item, data.taskId);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorDeleting", {
                                    objectName: objectType
                                }), error);
                            });
                    });
            });
    }

    function installUpdateRemoveCallback(objectType, itemType, item, taskId) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        assert(!isNullOrUndefined(taskId), "taskId must be defined");

        //we initialize the progress bar
        var $line = getLineFromItem(objectType, itemType);
        var progressBar = $line.find("div.progress-bar");
        progressBar.css("width", "0");

        //we listen for webSocket event
        $(document).on("taskupdatenotification." + taskId, function (e, taskUpdateInformation) {
            progressBar.css("width", taskUpdateInformation.progression + "%");
            $line.find("span.message").text($.t("core." + taskUpdateInformation.message));

            var taskFinished = false;
            //we manage the end of the task
            if (taskUpdateInformation.taskState.toLowerCase() === "fail") {
                console.error("Unable to install : " + taskUpdateInformation.exception);
                notifyError($.t("core." + taskUpdateInformation.message));
                taskFinished = true;
            } else if (taskUpdateInformation.taskState.toLowerCase() === "success") {
                notifySuccess($.t("core." + taskUpdateInformation.message));
                taskFinished = true;
            }

            if (taskFinished) {
                //we remove the progress information and restore buttons
                item.processing = false;
                scanForUpdates();
            }
        });
        //we hide the buttons and show the progression
        item.processing = true;
        updateLine(objectType, itemType, item);
    }


    function showChangelog(changelogUrl) {
        assert(!isNullOrUndefined(changelogUrl), "changelogUrl must be defined");

        Yadoms.modals.showChangelog.loadAsync()
            .done(function () {
                Yadoms.showChangelogModal(changelogUrl);
            });
    }
</script>