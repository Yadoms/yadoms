<div id="dashboard-plugins">
   <h1 class="page-header"><span class="fa fa-rocket"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.plugins.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.plugins.pluginInstanceListDescription"></span>
   <button id="btn-instantiate-plugin" type="button" class="btn btn-success"><span class="fa fa-rocket"></span>&nbsp;&nbsp;<span>Instantiate a new plugin</span></button>
   <table id="plugin-instance-list" class="table table-bordered table-striped">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.name"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.pluginName"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.status"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.launchAtStartup"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.actions"></td>
      </tr>
      <!-- plugin instance will be listed here-->
   </table>
</div>
<script>
      var pluginInstanceList = [];

      function initializePluginDashboard() {
         //we remove all rows except header
         $("table#plugin-instance-list").find("tr:gt(0)").remove();
         //we clear pluginInstance array
         pluginInstanceList = [];

         //we dynamically ask for plugins
         $.getJSON("/rest/plugin/instances")
            .done(function (data) {
               //we parse the json answer
               if (data.result != "true")
               {
                  notifyError($.t("modals.dashboard.sub-windows.plugins.errorGettingPluginList"), JSON.stringify(data));
                  return;
               }

               //we define action Buttons string once
               var actionsBtns = "<div class=\"btn-group\">\n" +
                                    "<button type=\"button\" class=\"btn btn-primary\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.configure\"><span class=\"glyphicon glyphicon-cog\"></span></button>\n" +
                                    "<button type=\"button\" class=\"btn btn-danger\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.delete\"><span class=\"glyphicon glyphicon-trash\"></span></button>\n" +
                                 "</div>";

               var autoStartCommand = "<input type=\"checkbox\">";

               //foreach result we append a <tr>
               $.each(data.data.plugin, function(index, value) {
                  var pi = new PluginInstance(value.id, value.name, value.pluginName, value.configuration, value.enabled);
                  pluginInstanceList.push(pi);
                  //we add it to the DOM
                  $("table#plugin-instance-list").append("<tr plugin-id=\"" + pi.id + "\"><td class=\"plugin-name\"></td><td class=\"plugin-pluginName\"></td><td class=\"plugin-status\"></td><td class=\"plugin-autoStart\"></td><td class=\"plugin-actions\"></td></tr>");
                  //we fill the data
                  $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-name").text(pi.name);
                  $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-pluginName").text(pi.pluginName);
                  $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-autoStart").html(autoStartCommand);
                  $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-status").text();


                  //we add actions to the plugin
                  $("table#plugin-instance-list").find("tr[plugin-id='" + pi.id + "']").find("td.plugin-actions").append(actionsBtns);
               });

               //we use the periodic task of the dashboard
               clearInterval(periodicDashboardTask);
               periodicDashboardTask = setInterval(periodicDashboardPluginTask, 1000);
               periodicDashboardPluginTask();
            })
            .fail(function() {notifyError($.t("modals.dashboard.sub-windows.plugins.errorGettingPluginList"), JSON.stringify(data));});
      }

   function periodicDashboardPluginTask() {
      //periodically we check the status of each plugin
      if (serverIsOnline) {
         $.each(pluginInstanceList, function(index, value) {
            //we ask async for the status
            value.getStatus(function (status) {
               if (status != value.lastRunningStatus) {
                  var textStatus = "";
                  var btn;
                  if(status) {
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("td.plugin-name").addClass("success");
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("td.plugin-name").removeClass("danger");
                     btn = "<button type=\"button\" class=\"btn btn-warning\" data-i18n=\"modals.dashboard.sub-windows.plugins.stop\"></button>";
                  }
                  else {
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("td.plugin-name").removeClass("success");
                     $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("td.plugin-name").addClass("danger");
                     btn = "<button type=\"button\" class=\"btn btn-success\" data-i18n=\"modals.dashboard.sub-windows.plugins.start\"></button>";
                  }

                  $("table#plugin-instance-list").find("tr[plugin-id='" + value.id + "']").find("td.plugin-status").html(btn).i18n();
               }
            });
         });
      }
   }
</script>
