<div id="dashboard-plugins">
   <h1 class="page-header"><span class="fa fa-rocket"></span>&nbsp;<span data-i18n="modals.dashboard.sub-windows.plugins.title"></span></h1>
   <span data-i18n="modals.dashboard.sub-windows.plugins.pluginInstanceListDescription"></span><br>
   <button id="btn-add-new-plugin" type="button" class="btn btn-success dashboard-btn-new"><span class="fa fa-rocket"></span>&nbsp;&nbsp;<span data-i18n="modals.dashboard.sub-windows.plugins.new"></span></button>
   <table id="plugin-instance-list" class="table table-bordered table-striped dashboard-list">
      <tr>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.displayName"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.type"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.launchAtStartup"></td>
         <td data-i18n="modals.dashboard.sub-windows.plugins.table.actions"></td>
          <td data-i18n="modals.dashboard.sub-windows.plugins.table.status"></td>
      </tr>
      <!-- plugin instance will be listed here-->
   </table>
</div>
<script>
   var pluginInstanceList = [];

   Yadoms.initializePluginDashboard = function() {
      //we remove all rows except header
      $("table#plugin-instance-list").find("tr:gt(0)").remove();
      //we clear pluginInstance array
      pluginInstanceList = [];

      $("#btn-add-new-plugin").unbind("click").bind("click", function() { addNewPlugin(); });

      //we dynamically ask for plugins (async)
      PluginInstanceManager.getAll().done(function(allInstances) {
         //foreach result we append a <tr>
         $.each(allInstances, function(index, value) {
            pluginInstanceList.push(value);
            //we don't show system plugins to user
            if (!value.isSystemCategory()) {
               addPluginInstanceToDom(value);
            }
         });

         //we use the periodic task of the dashboard
         clearInterval(Yadoms.periodicDashboardTask);
         Yadoms.periodicDashboardTask = setInterval(periodicDashboardPluginTask, 2000);
         periodicDashboardPluginTask();
      });
   };

   function getPluginDomRow(pluginInstance) {
      return $("table#plugin-instance-list").find("tr[plugin-id='" + pluginInstance.id + "']");
   }

   function addPluginInstanceToDom(pi) {
       var name = "<span>" + pi.displayName + "</span>";

       var failToLoadPluginPackage =  pi.package === null ||  pi.package === undefined || pi.package.failToLoad === true;

       var type = "<img src=\"plugins/" + pi.type + "/icon.png\" class=\"img-thumbnail dashboard-table-icon\">&nbsp;&nbsp;" +
                   "<span>" + $.t("plugins/" + pi.type + ":name", { defaultValue: pi.package.name }) + "</span>";

       var autoStartCommand = "<input class=\"cb-autoStart\" type=\"checkbox\">";
       if (failToLoadPluginPackage === true)
           autoStartCommand = "";

       var actionsBtns = "<div class=\"btn-group\">\n" +
              ((failToLoadPluginPackage === true)?"":"<button type=\"button\" class=\"btn btn-startStop\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.startStop\"><span class=\"fa fa-power-off\"></span></button>\n") +
              ((failToLoadPluginPackage === true)?"":"<button type=\"button\" class=\"btn btn-primary btn-configure\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.configure\"><span class=\"fa fa-cog\"></span></button>\n");
              
      $.each(pi.package.extraCommands, function(index, values) {
         actionsBtns += "<button type=\"button\" class=\"btn btn-success btn-extraCommand btn-extraCommand-" + values.command + "\"><span class=\"" + values.icon +"\"></span></button>\n";
      });
   
       actionsBtns += "<button type=\"button\" class=\"btn btn-danger btn-delete\" data-i18n=\"[title]modals.dashboard.sub-windows.plugins.delete\"><span class=\"fa fa-trash\"></span></button>\n" +
              "</div>";

       var statusField = "<span class=\"label label-success label-status\"></span>\n";
       if (failToLoadPluginPackage === true)
           statusField = "<span class=\"label label-danger\" data-i18n=\"modals.dashboard.sub-windows.plugins.packageError\"></span>\n";

      //we add it to the DOM
      var $pluginInstanceList = $("table#plugin-instance-list");

      $pluginInstanceList.append("<tr plugin-id=\"" + pi.id + "\">" +
          "<td class=\"plugin-displayName vert-align\"></td>" +
          "<td class=\"plugin-type vert-align\" align=\"left\"></td>" +
          "<td class=\"plugin-autoStart vert-align\"></td>" +
          "<td class=\"plugin-actions vert-align\"></td>" +
          "<td class=\"plugin-status vert-align\"></td>" +
          "</tr>");

      var $pluginInstanceRow = getPluginDomRow(pi);
      //we fill the data
      $pluginInstanceRow.find("td.plugin-displayName").html(name);
      $pluginInstanceRow.find("td.plugin-type").html(type);
      $pluginInstanceRow.find("td.plugin-autoStart").html(autoStartCommand);
      $pluginInstanceRow.find("td.plugin-actions").append(actionsBtns);
      $pluginInstanceRow.find("td.plugin-status").html(statusField);

      //we set autostart value
      $pluginInstanceRow.find("input.cb-autoStart").prop("checked", pi.autoStart);

      //we bind event on the different actions
       if (!failToLoadPluginPackage) {
          $pluginInstanceRow.find("button.btn-startStop").unbind('click').bind('click', function () {startStopPlugin(pi); });
          $pluginInstanceRow.find("button.btn-configure").unbind('click').bind('click', function () {configurePlugin(pi); });
          $pluginInstanceRow.find("input.cb-autoStart").unbind('change').bind('change', function () {autoStartChange(pi); });
       }
       $pluginInstanceRow.find("button.btn-delete").unbind('click').bind('click', function() { deletePlugin(pi); });

       $.each(pi.package.extraCommands, function(index, values) {
          $pluginInstanceRow.find("button.btn-extraCommand-" + values.command).unbind('click').bind('click', function() { onExtraCommand(pi, values); });
       });
      
      $pluginInstanceRow.i18n();
   }

   function addExtraCommand(pluginPackage) {
      var result = "";
   

   }
   
   function startStopPlugin(pi) {
      //pi represent the pluginInstance concerned
      assert(!isNullOrUndefined(pi), "pi must be defined");
      //we deactivate the button until next status will be acquired to prevent flooding
      getPluginDomRow(pi).find("button.btn-startStop").prop('disabled', true);
      if (pi.lastState === "Stopped" || pi.lastState === "Error") {
         //we ask for start
         PluginInstanceManager.start(pi).done(function () {
            getPluginDomRow(pi).find("button.btn-startStop").prop('disabled', false);
         });
      }
      else {
         //we ask for stop
         PluginInstanceManager.stop(pi).done(function () {
            getPluginDomRow(pi).find("button.btn-startStop").prop('disabled', false);
         });
      }
   }

   function configurePlugin(pi) {
      //pi represent the pluginInstance concerned
      //we get package.json
      PluginInstanceManager.downloadPackage(pi).done(function() {
         //we ask for configuration modal async
         Yadoms.modals.pluginConfigure.loadAsync()
         .done(function () {
            Yadoms.configurePluginInstance(pi, function() {
                  PluginInstanceManager.updateToServer(pi)
                     .done(function() {
                        //We update the information that can have changed after the configuration
                        var $row = getPluginDomRow(pi);
                        $row.find("td.plugin-displayName").html(pi.displayName);
                     })
                     .fail(function(error) {
                        notifyError($.t("modals.configure-plugin.pluginFailToConfigure", { pluginName: pi.displayName }), error);
                     });
            });
         });
      });
   }

   function deletePlugin(pi) {
      //pi represent the pluginInstance concerned
      Yadoms.modals.confirmation.loadAsync()
      .done(function () {
         Yadoms.showConfirmModal(Yadoms.btnKind.yesNo, null, $.t("modals.dashboard.sub-windows.plugins.confirmPluginDeletion", { pluginName: pi.displayName }),
         function () {
            //deletion has been confirmed
            var deletePromsie = PluginInstanceManager.deleteFromServer(pi);

            //disable button access until promise result
            getPluginDomRow(pi).find("button").prop('disabled', true);

            deletePromsie.done(function () {
               //we remove pi from array
               var i = pluginInstanceList.indexOf(pi);
               if (i !== -1) {
                  pluginInstanceList.splice(i, 1);
               }

               //we remove pi from dom
               getPluginDomRow(pi).remove();
            });

            //if it fails, restore button access
            deletePromsie.fail(function (error) {
               notifyError($.t("modals.configure-plugin.pluginFailToDelete", { pluginName: pi.displayName }), error);
               getPluginDomRow(pi).find("button").prop('disabled', false);
            });
         });
      });
   }

   function autoStartChange(pi) {
      //pi represent the pluginInstance concerned
      //we set autoStart attr to cb value and send it to the server as an update
      pi.autoStart = getPluginDomRow(pi).find("input.cb-autoStart").prop("disabled", true).prop("checked");

      PluginInstanceManager.updateToServer(pi)
      .done(function () {
         getPluginDomRow(pi).find("input.cb-autoStart").prop("disabled", false).prop("checked", pi.autoStart);
      })
      .fail(function (error) {
         notifyError($.t("modals.configure-plugin.pluginFailToConfigure", { pluginName: pi.displayName }), error);
      });
   }

   function onExtraCommand(pi, extraCommand) {
      PluginInstanceManager.postExtraCommand(pi, extraCommand);
   }
   
   function periodicDashboardPluginTask() {
       //periodically we check the status of each plugin
       if (serverIsOnline) {
           $.each(pluginInstanceList, function (index, pluginInstance) {

               PluginInstanceManager.getState(pluginInstance)
               .done(function (status) {
                       if (status) {
                           var $row = getPluginDomRow(pluginInstance);
                           if (status.state !== pluginInstance.lastState) {

                               // Update start/stop button
                               var $startStopButton = $row.find("button.btn-startStop");
                               if (status.state === "Stopped") {
                                   $startStopButton.addClass("btn-success").removeClass("btn-warning");
                               } else {
                                   $startStopButton.removeClass("btn-success").addClass("btn-warning");
                               }

                               // Update state label
                               var $label = $row.find("span.label-status");
                               if ($label) {
                                   switch (status.state) {
                                   case "Error":
                                       $label.removeClass("label-success").removeClass("label-warning").addClass("label-danger").text(getCustomMessage(pluginInstance, status.messageId, "modals.dashboard.sub-windows.plugins.error"));
                                       break;
                                   case "Stopped":
                                       $label.removeClass("label-success").addClass("label-warning").removeClass("label-danger").text($.t("modals.dashboard.sub-windows.plugins.stopped"));
                                       break;
                                   case "Running":
                                       $label.addClass("label-success").removeClass("label-warning").removeClass("label-danger").text($.t("modals.dashboard.sub-windows.plugins.running"));
                                       break;
                                   case "Custom":
                                       $label.removeClass("label-success").addClass("label-warning").removeClass("label-danger").text(getCustomMessage(pluginInstance, status.messageId, "modals.dashboard.sub-windows.plugins.starting"));
                                       break;
                                   default:
                                       $label.removeClass("label-danger").text("");
                                       break;
                                   }
                               }
                           }
                           pluginInstance.lastState = status.state;
                       }
                   });
           });
       }
   }

   function getCustomMessage(pluginInstance, messageId, defaultMessage) {
       return $.t("plugins/" + pluginInstance.type + ":customLabels.pluginState." + messageId, { defaultValue: $.t(defaultMessage) });
   }

   function addNewPlugin() {
      Yadoms.modals.pluginAdd.loadAsync()
      .done(function() {
         Yadoms.askPluginTypes(function(pluginType) {
            var pi = new PluginInstance(null, $.t("plugins/" + pluginType.type + ":name", {defaultValue : pluginType.package.name}), pluginType.type, "", 1, "user");
            //we get package.json
            PluginInstanceManager.downloadPackage(pi).done(function() {
               //we ask for configuration modal async
               Yadoms.modals.pluginConfigure.loadAsync()
               .done(function() {
                  //we launch configureInstance GUI
                  Yadoms.configurePluginInstance(pi, function () {
                     //we ask for pluginInstance creation
                      PluginInstanceManager.createToServer(pi)
                          .done(function() {
                              notifySuccess($.t("modals.configure-plugin.pluginSuccessfullyCreated"));
                              addPluginInstanceToDom(pi);
                              pluginInstanceList.push(pi);
                          })
                          .fail(function(error) {
                              notifyError($.t("modals.configure-plugin.pluginFailToCreate", { pluginName: pi.displayName }), error);
                          });
                  });
               });
            });
         });
      });
   }

</script>
