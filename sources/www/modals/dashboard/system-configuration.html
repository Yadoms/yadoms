<div id="dashboard-system-configuration">
      <h1 class="page-header">
            <span class="fa fa-cogs"></span>&nbsp;
            <span data-i18n="modals.dashboard.sub-windows.system-configuration.title"></span>
      </h1>
      <form novalidate>
            <div class="form-group">
                  <!--configuration will be inserted here-->
            </div>
            <div class="modal-footer">
                  <div class="form-actions">
                        <button id="resetSystemConfiguration" type="button" class="btn btn-default" data-i18n="common.resetToDefault"></button>
                        <button type="submit" id="btn-confirm-configure-system" class="btn btn-primary" data-i18n="common.apply"></button>
                  </div>
            </div>
      </form>
</div>

<script>
      var fakePassword = createUUID();
      var pageHasToBeReloaded = false;

      var languageParameter;

      var locationSectionParameters;
      var latitudeParameter;
      var longitudeParameter;
      var timezoneParameter;

      var basicAuthenticationSectionParameters;
      var userAuthenticationParameter;
      var passwordAuthenticationParameter;
      var password2AuthenticationParameter;

      var advancedSectionParameters;
      var dateFormatStringParameter;
      var refreshPageBoolParameter;


      Yadoms.initializeSystemConfigurationDashboard = function () {
            var i18NContext = "modals.dashboard.sub-windows.system-configuration.configuration-items.";
            var $modalBody = $("div#dashboard-system-configuration .form-group");
            $modalBody.empty();

            var promise = new $.Deferred();

            //get current system configuration
            var deferredArray = [];
            var d1 = new $.Deferred();
            var systemConfiguration;

            //we update system configuration to be sure to modify the latest version of the configuration
            ConfigurationManager.loadSystemConfiguration()
                  .done(function (data) {
                        systemConfiguration = data;
                        d1.resolve();
                  })
                  .fail(function (error) {
                        //an error has occurred during loading
                        notifyError($.t(
                                    "modals.dashboard.sub-windows.system-configuration.errorDuringLoadingConfiguration"
                              ),
                              error);
                        d1.reject();
                  });
            deferredArray.push(d1);

            var d2 = new $.Deferred();
            var supportedTimezones = null;
            RestEngine.getJson("/rest/system/binding/supportedTimezones")
                  .done(function (data) {
                        supportedTimezones = data;
                        d2.resolve();
                  })
                  .fail(function (error) {
                        notifyError($.t(
                              "modals.dashboard.sub-windows.system-configuration.errorDuringLoadingConfiguration"
                        ), error);
                        d2.reject();
                  });
            deferredArray.push(d2);

            // When systemSection is done
            $.whenAll(deferredArray)
                  .done(function () {
                        createParameters($modalBody, i18NContext, systemConfiguration, supportedTimezones);

                        $modalBody.i18n();

                        $modalBody.find("input,select,textarea").jqBootstrapValidation("destroy").jqBootstrapValidation({
                              preventSubmit: true,
                              submitError: function ($form, event, errors) {
                                    console.warn("Unable to validate form: " + errors);
                                    promise.reject();
                              },
                              submitSuccess: function ($form, event) {
                                    event.preventDefault();
                                    saveParameters(systemConfiguration);
                                    promise.resolve();
                              },
                              filter: function () {
                                    //we check only control that have class enable-validation and are visible
                                    return $(this).is(".enable-validation") &&
                                          $(this).is(":visible");
                              }
                        })

                        $("button#resetSystemConfiguration").unbind('click').bind('click',
                              resetSystemConfiguration);
                  });

            return promise.promise();
      }

      function createParameters($body, i18NContext, systemConfiguration, supportedTimezones) {
            //*************
            //language
            languageParameter = new EnumParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.language, {
                        "values": window.getSupportedLanguages(),
                        "defaultValue": getdefaultLanguageFromSupported(),
                        "sort": true
                  },
                  systemConfiguration[ConfigurationManager.items.system
                        .language]);

            //*************
            //City section parameters
            createLocationSectionParameters(i18NContext, systemConfiguration, supportedTimezones);

            //*************
            //Basic Authentication parameters
            createBasicAuthenticationSectionParameters(i18NContext, systemConfiguration);

            //*************
            //advanced parameters
            createAdvancedSectionParameters(i18NContext, systemConfiguration);


            //and add to the gui
            $body.append(languageParameter.getDOMObject());
            $body.append(locationSectionParameters.getDOMObject());
            $body.append(basicAuthenticationSectionParameters.getDOMObject());
            $body.append(advancedSectionParameters.getDOMObject());

            //we finish controls instantiation
            if ($.isFunction(languageParameter.applyScript))
                  languageParameter.applyScript();
            if ($.isFunction(locationSectionParameters.applyScript))
                  locationSectionParameters.applyScript();
            if ($.isFunction(basicAuthenticationSectionParameters.applyScript))
                  basicAuthenticationSectionParameters.applyScript();
            if ($.isFunction(advancedSectionParameters.applyScript))
                  advancedSectionParameters.applyScript();
      }


      function createLocationSectionParameters(i18NContext, systemConfiguration, supportedTimezones) {

            latitudeParameter = new StringParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.location.latitude, {
                        "regex": "^-?[0-9]+(\.[0-9]+)?$",
                        "required": "true"
                  },
                  systemConfiguration.location[ConfigurationManager.items
                        .system.location
                        .latitude]);

            longitudeParameter = new StringParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.location.longitude, {
                        "regex": "^-?[0-9]+(\.[0-9]+)?$",
                        "required": "true"
                  },
                  systemConfiguration.location[ConfigurationManager.items
                        .system.location
                        .longitude]);

            timezoneParameter = new EnumParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.location.timezone, {
                        "values": supportedTimezones,
                        "sort": true
                  },
                  systemConfiguration.location[ConfigurationManager.items
                        .system.location
                        .timezone]);

            // Add sub elements to the city section
            locationSectionParameters = new SectionParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.locationSection, {},
                  ConfigurationManager.items.system.locationSection);

            locationSectionParameters.configurationHandlers.push(latitudeParameter);
            locationSectionParameters.configurationHandlers.push(longitudeParameter);
            locationSectionParameters.configurationHandlers.push(timezoneParameter);
      }

      function createBasicAuthenticationSectionParameters(i18NContext, systemConfiguration) {

            var basicAuth = systemConfiguration[ConfigurationManager.items.system.basicAuthentication];

            //we affect a fake password if there is already one to help password modification detection
            var passwordToDisplay = "";
            if (basicAuth.password !== "") {
                  passwordToDisplay = fakePassword;
            }

            //*************
            //user authentication
            userAuthenticationParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthenticationUser, {
                        "defaultValue": basicAuth.user,
                        "required": "true"
                  },
                  basicAuth.user,
                  "username");

            //*************
            //password authentication
            passwordAuthenticationParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthenticationPassword, {
                        "defaultValue": basicAuth.password,
                        "required": "true",
                        "encrypted": "true",
                        "decryptable": "false"
                  },
                  passwordToDisplay,
                  "new-password");

            //*************
            //password authentication
            password2AuthenticationParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthenticationPassword2, {
                        "defaultValue": basicAuth.password,
                        "required": "true",
                        "encrypted": "true",
                        "decryptable": "false",
                        "mustMatchTo": passwordAuthenticationParameter.uuid
                  },
                  passwordToDisplay,
                  "new-password");

            basicAuthenticationSectionParameters = new SectionParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthentication, {
                        "enableWithCheckBox": true,
                        "enableWithCheckBoxDefaultValue": basicAuth.active
                  }, {
                        "checkbox": basicAuth.active
                  }
            );

            basicAuthenticationSectionParameters.configurationHandlers.push(userAuthenticationParameter);
            basicAuthenticationSectionParameters.configurationHandlers.push(passwordAuthenticationParameter);
            basicAuthenticationSectionParameters.configurationHandlers.push(password2AuthenticationParameter);
      }

      function createAdvancedSectionParameters(i18NContext, systemConfiguration) {

            //*************
            //dateFormatString
            dateFormatStringParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.dateFormatString, {
                        defaultValue: systemConfiguration[ConfigurationManager.items.system.dateFormatString].defaultValue,
                        "required": "true"
                  },
                  systemConfiguration[ConfigurationManager.items.system.dateFormatString]
            );

            //*************
            //refresh page : keep the active page
            refreshPageBoolParameter = new BoolParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.refreshPage, {
                        defaultValue: systemConfiguration[ConfigurationManager.items.system.refreshPage].defaultValue
                  },
                  systemConfiguration[ConfigurationManager.items.system.refreshPage]
            );

            advancedSectionParameters = new SectionParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.advancedParameters, {
                        "enableWithCheckBox": true,
                        "enableWithCheckBoxDefaultValue": systemConfiguration[ConfigurationManager.items.system.advancedParameters]
                              .defaultValue
                  }, {
                        "checkbox": systemConfiguration[ConfigurationManager.items.system.advancedParameters]
                  });

            advancedSectionParameters.configurationHandlers.push(dateFormatStringParameter);
            advancedSectionParameters.configurationHandlers.push(refreshPageBoolParameter);
      }


      function saveParameters(systemConfiguration) {
            debugger;
            pageHasToBeReloaded = false;

            var arrayOfDeffered = [];

            arrayOfDeffered.push(readLanguageParameter(systemConfiguration));
            arrayOfDeffered.push(readAdvancedParameters(systemConfiguration));
            arrayOfDeffered.push(readFormatString(systemConfiguration));
            arrayOfDeffered.push(readBasicAuthentification(systemConfiguration));
            arrayOfDeffered.push(readLocation(systemConfiguration));
            arrayOfDeffered.push(readRefreshPage(systemConfiguration));

            $.whenAll(arrayOfDeffered)
                  .always(function () {
                        ConfigurationManager.saveSystemConfiguration(systemConfiguration)
                              .done(function () {
                                    notifySuccess($.t(
                                          "modals.dashboard.sub-windows.system-configuration.configurationSaved"
                                    ));

                                    if (pageHasToBeReloaded) {
                                          $("html").i18n();
                                          window.location.reload();
                                    }
                              })
                              .fail(function (error) {
                                    //an error has occurred during saving
                                    notifyError($.t(
                                          "modals.dashboard.sub-windows.system-configuration.errorDuringSavingConfiguration"
                                    ), error);
                              });
                  });
      }


      function readLanguageParameter(systemConfiguration) {
            var d = new $.Deferred();

            languageParameter.getCurrentConfiguration()
                  .done(function (newValue) {
                        systemConfiguration[ConfigurationManager.items.system.language] = newValue;

                        if (i18next.language !== newValue) {
                              //we change language of i18n
                              i18next.changeLanguage(systemConfiguration[ConfigurationManager.items.system.language],
                                    function () {
                                          pageHasToBeReloaded = true;
                                    });
                        }
                        d.resolve();
                  })
                  .fail(function () {
                        console.error("failed to get language parameter");
                        d.reject();
                  });
            return d;
      }

      function readAdvancedParameters(systemConfiguration) {
            var d = new $.Deferred();

            advancedSectionParameters.getCurrentConfiguration()
                  .done(function (currentconfiguration) {
                        systemConfiguration[ConfigurationManager.items.system.advancedParameters].value =
                              currentconfiguration.checkbox;
                        d.resolve();
                  }).fail(d.reject);
            return d;
      };

      function readFormatString(systemConfiguration) {
            var d = new $.Deferred();

            dateFormatStringParameter.getCurrentConfiguration()
                  .done(function (currentconfiguration) {
                        systemConfiguration[ConfigurationManager.items.system.dateFormatString].value =
                              currentconfiguration;
                        d.resolve();
                  }).fail(d.reject);
            return d;
      };

      function readBasicAuthentification(systemConfiguration) {
            var d2 = new $.Deferred();
            var currentBasicAuth = systemConfiguration[ConfigurationManager.items.system.basicAuthentication];
            var newBasicAuth = {};

            basicAuthenticationSectionParameters.getCurrentConfiguration()
                  .done(function (currentConfiguration) {
                        newBasicAuth.active = currentConfiguration.checkbox ? "true" : "false";

                        //if we activate / deactivate the authentication we must reload the page
                        if (newBasicAuth.active !== currentBasicAuth.active)
                              pageHasToBeReloaded = true;

                        if (newBasicAuth.active === "true") {
                              //the authentication method is active
                              userAuthenticationParameter.getCurrentConfiguration()
                                    .done(function (userConfig) {

                                          newBasicAuth.user = userConfig;
                                          if (newBasicAuth.user !== currentBasicAuth.user)
                                                pageHasToBeReloaded = true;

                                          //we check for password modification
                                          passwordAuthenticationParameter.getCurrentConfiguration()
                                                .done(function (password) {
                                                      var newPass = password;
                                                      if (newPass !== $.md5(fakePassword)) {
                                                            //the password has been changed
                                                            newBasicAuth.password = newPass;
                                                            //we has to reload the page
                                                            pageHasToBeReloaded = true;
                                                      } else {
                                                            //we set the previous one
                                                            newBasicAuth.password = currentBasicAuth.password;
                                                      }
                                                      d2.resolve();
                                                }).fail(d2.reject);
                                    }).fail(d2.reject);
                        } else {
                              userAuthenticationParameter.getCurrentConfiguration()
                                    .done(function (authparam) {
                                          //the authentication method is inactive
                                          newBasicAuth.user = authparam;
                                          //we clear the password for the next re-activation
                                          newBasicAuth.password = "";

                                          d2.resolve();
                                    }).fail(d2.reject);
                        }

                  }).fail(d2.reject);

            var d = new $.Deferred();
            d2.promise().done(function () {
                        systemConfiguration[ConfigurationManager.items.system.basicAuthentication] = newBasicAuth;
                        d.resolve();
                  })
                  .fail(d.reject);
            return d;
      }

      function readLocation(systemConfiguration) {
            var d = new $.Deferred();

            var arrayOfDeffered = [];
            var d1 = new $.Deferred();
            latitudeParameter.getCurrentConfiguration()
                  .done(function (lat) {
                        systemConfiguration.location[ConfigurationManager.items.system.location.latitude] =
                              lat;
                        d1.resolve();
                  })
                  .fail(d1.reject);
            arrayOfDeffered.push(d1);

            var d2 = new $.Deferred();
            longitudeParameter.getCurrentConfiguration()
                  .done(function (lon) {
                        systemConfiguration.location[ConfigurationManager.items.system.location.longitude] =
                              lon;
                        d2.resolve();
                  })
                  .fail(d2.reject);
            arrayOfDeffered.push(d2);

            var d3 = new $.Deferred();
            timezoneParameter.getCurrentConfiguration()
                  .done(function (tz) {
                        systemConfiguration.location[ConfigurationManager.items.system.location.timezone] =
                              tz;
                        d3.resolve();
                  })
                  .fail(d3.reject);
            arrayOfDeffered.push(d3);

            $.whenAll(arrayOfDeffered)
                  .done(d.resolve)
                  .fail(d.reject);
            return d;
      }

      function readRefreshPage(systemConfiguration) {
            var d = new $.Deferred();

            refreshPageBoolParameter.getCurrentConfiguration()
                  .done(function (currentconfiguration) {
                        systemConfiguration[ConfigurationManager.items.system.refreshPage].value =
                              currentconfiguration;
                        d.resolve();
                  }).fail(d.reject);
            return d;
      };

      function resetSystemConfiguration() {
            Yadoms.modals.confirmation.loadAsync()
                  .done(function () {
                        Yadoms.showConfirmModal(Yadoms.btnKind.yesNo, null,
                              $.t("modals.dashboard.sub-windows.system-configuration.confirmResetToDefault"),
                              function () {
                                    ConfigurationManager.resetSystemConfiguration()
                                          .done(function () {
                                                $("html").i18n();
                                                window.location.reload();
                                          });
                              },
                              function () {
                                    promise.resolve();
                              });
                  });
      }

      function getdefaultLanguageFromSupported() { //TODO utile ?
            var navigatorLanguage = navigator.language || navigator.userLanguage;
            var langs = window.getSupportedLanguages();
            return isNullOrUndefined(langs[navigatorLanguage]) ? Object.keys(langs)[0] :
                  navigatorLanguage;
      }
</script>