<!--Edit automation Rule Modal -->
<div class="modal fade" id="automation-rule-new-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog automation-rule-new-modal">
        <div class="modal-content">
           <form class="form-horizontal" novalidate >
              <div class="modal-header">
                   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                   <h4 class="modal-title" data-i18n="modals.new-automation-rule.title"></h4>
              </div>
              <div class="modal-body form-group">
                   <h4 data-i18n="modals.new-automation-rule.newRule"></h4>
                   <span data-i18n="modals.new-automation-rule.choose-language"></span>
                   <div class="language-btns"></div>
                   <h4 data-i18n="modals.new-automation-rule.from-model"></h4>
                   <span data-i18n="modals.new-automation-rule.choose-model"></span>
                   <div class="models-btns"></div>
              </div>
              <div class="modal-footer">
                 <div class="form-actions">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.cancel"></button>
                 </div>
              </div>
           </form>
        </div>
    </div>
</div>

<script>
   function showNewAutomationRule(callback) {
      assert($.isFunction(callback), "callback must be defined");

      var $modalBody = $("div#automation-rule-new-modal .modal-body");

      //TODO V2 : request languages
      var languageList = [];
      languageList.push(new AutomationLanguage("python",
                                                      "#!/usr/bin/env python\n#author          :enter your name here\n#date            :\n#version         :0.1 Alpha\n#notes           :\n#==================================================\n"));

      //we create buttons to select language
      var $area = $modalBody.find("div.language-btns");

      $area.empty();

      $area.append("<button class=\"btn btn-primary btn-lg btn-blockly\" type=\"button\">" +
      "<span class=\"fa fa-puzzle-piece\"></span>&nbsp;&nbsp;" +
      BlocklyName + "</button>");
      //we manage the click event
      $area.find("button.btn-blockly").unbind("click").bind("click", newEmptyBlockly());

      $.each(languageList, function (key, value) {
         $area.append("<button language=\"" + value.name + "\" class=\"btn btn-primary btn-lg btn-language\" type=\"button\">" +
         "<span class=\"fa fa-code\"></span>&nbsp;&nbsp;" +
         value.name + "</button>");

         var $btn = $("button.btn-language[language='" + value.name + "']");

         //we manage the click event
         $area.find("button.btn-language").unbind("click").bind("click", newEmptyFile(value));
      });

      //TODO V2 : request models
      var modelList = [];
      modelList.push({"name" : "If Then", "description" : "Simple If Then rule model", "language" : BlocklyName, "content" : "<xml>if then</xml>"});
      modelList.push({"name" : "If Then Else", "description" : "Full If Then Else rule model", "language" : BlocklyName, "content" : "<xml>if then else</xml>"});

      $area = $modalBody.find("div.models-btns");
      $area.empty();

      $.each(modelList, function (key, value) {
         var btn = "<button content=\"" + value.content + "\" class=\"btn btn-primary btn-lg btn-model\" type=\"button\">" +
                     "<div>" +
                        "<h3>" + value.name + "</h3>" +
                        "<h4>" + value.description + "</h4>" +
                     "</div>";
         if (value.language == BlocklyName)
            btn +=   "<h5 class=\"pull-right language\"><span class=\"fa fa-puzzle-piece\"></span>&nbsp;&nbsp;";
         else
            btn +=   "<h5 class=\"pull-right language\"><span class=\"fa fa-code\"></span>&nbsp;&nbsp;";

         btn +=         value.language + "</h5>" +
                   "</button>";

         $area.append(btn);
      });

      //i18n
      $modalBody.i18n();

      //we display the modal
      $("div#automation-rule-new-modal").modal();
   }

   function newEmptyFile(language) {
      return function (object) {
         //we create the empty rule and go to edition
         var r = new AutomationRule(-1, "", "", language.name, "", "", language.newFileTemplate, "", true);
         modals.automationRuleEditCode.load(function () {
            showEditionAutomationRuleWithCode(r, function () {
               AutomationRuleManager.createToServer(r);
            });
         });
      }
   }

   /**
    * Create a new empty rule with Blockly editor
    * @return {Function}
    */
   function newEmptyBlockly() {
      return function () {
         //we create the empty rule and go to edition
         var r = new AutomationRule(-1, "", "", BlocklyName, "", "", "", "", true);
         modals.automationRuleEditBlockly.load(function () {
            showEditionAutomationRuleWithBlockly(r, function () {
               AutomationRuleManager.createToServer(r, function(result) {
                  //if it's okay
                  if (result) {
                     notifySuccess($.t("modals.dashboard.sub-windows.automation-center.ruleSuccessfullyCreated"));
                  }
               });
            });
            $("div#automation-rule-new-modal").modal("hide");
         });
      }
   }

</script>